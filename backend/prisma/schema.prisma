// Prisma schema for Visitor & Delivery Management System
// PostgreSQL 16

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USERS ============
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(RECEPTION)
  hostId    BigInt?
  host      Host?    @relation(fields: [hostId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs      AuditLog[]
  checkEvents    CheckEvent[]
  refreshTokens  RefreshToken[]
}

enum Role {
  ADMIN
  RECEPTION
  HOST
}

// ============ REFRESH TOKENS ============
model RefreshToken {
  id        String    @id @default(cuid())
  userId    Int
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ============ HOSTS ============
model Host {
  id         BigInt     @id @default(autoincrement())
  externalId String?    @unique
  name       String     @db.VarChar(100)
  company    String     @db.VarChar(100)
  email      String?    @db.VarChar(100)
  location   Location?
  phone      String?    @db.VarChar(191)
  status     Int        @default(1) @db.SmallInt
  deletedAt  DateTime?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  visits     Visit[]
  deliveries Delivery[]
  users      User[]

  @@index([status])
  @@index([location])
  @@index([status, location])
}

enum Location {
  BARWA_TOWERS    @map("Barwa Towers")
  MARINA_50       @map("Marina 50")
  ELEMENT_MARIOTT @map("Element Mariott")
}

// ============ VISITS ============
model Visit {
  id                 String      @id @default(cuid())
  sessionId          String      @unique
  visitorName        String
  visitorCompany     String
  visitorPhone       String
  visitorEmail       String?
  hostId             BigInt
  host               Host        @relation(fields: [hostId], references: [id])
  purpose            String
  location           Location
  status             VisitStatus @default(PRE_REGISTERED)

  preRegisteredById String?
  expectedDate      DateTime?
  approvedAt        DateTime?
  rejectedAt        DateTime?
  rejectionReason   String?

  checkInAt   DateTime?
  checkOutAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  qrToken    QrToken?
  checkEvents CheckEvent[]

  @@index([status])
  @@index([checkInAt])
  @@index([status, checkInAt])
  @@index([hostId])
  @@index([location])
  @@index([status, location])
}

enum VisitStatus {
  PRE_REGISTERED
  PENDING_APPROVAL
  APPROVED
  REJECTED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
}

// ============ QR TOKENS ============
model QrToken {
  id        String   @id @default(cuid())
  visitId   String   @unique
  visit     Visit    @relation(fields: [visitId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  usedAt   DateTime?
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

// ============ CHECK EVENTS ============
model CheckEvent {
  id        String    @id @default(cuid())
  visitId   String
  visit     Visit     @relation(fields: [visitId], references: [id], onDelete: Cascade)
  type      CheckType
  userId    Int?
  user      User?     @relation(fields: [userId], references: [id])
  ip        String?
  userAgent String?
  createdAt DateTime  @default(now())

  @@index([visitId])
  @@index([userId])
}

enum CheckType {
  CHECK_IN
  CHECK_OUT
}

// ============ DELIVERIES ============
model Delivery {
  id           String         @id @default(cuid())
  deliveryType String?
  recipient    String
  hostId       BigInt?
  host         Host?          @relation(fields: [hostId], references: [id])
  courier      String
  location     Location
  status       DeliveryStatus @default(RECEIVED)
  notes        String?
  createdAt    DateTime       @default(now())
  receivedAt   DateTime       @default(now())
  receivedById String?
  pickedUpAt   DateTime?

  @@index([status])
  @@index([receivedAt])
  @@index([status, receivedAt])
  @@index([hostId])
  @@index([location])
}

enum DeliveryStatus {
  RECEIVED
  PICKED_UP
}

// ============ AUDIT LOG ============
model AuditLog {
  id        String   @id @default(cuid())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  entity    String
  entityId  String?
  oldValue  Json?
  newValue  Json?
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

// ============ LOOKUP TABLES ============
model LookupPurpose {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  label     String
  active    Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
}

model LookupDeliveryType {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  label     String
  active    Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
}

model LookupCourier {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  label     String
  active    Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
}

model LookupLocation {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  label     String
  active    Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active])
}
