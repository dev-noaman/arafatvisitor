import{r as a,j as e,c as J,t as X,o as Z,s as P,a as V,u as ee}from"./index-D0-OHiwP.js";import{a as te,b as se}from"./lookups-N2DhjBJP.js";import{g as re}from"./hosts-D5r7ZRy9.js";import{S as R}from"./SearchableSelect-D63tGwCQ.js";import{g as O,a as H,b as le,u as ae,c as oe,m as ie,d as ne}from"./deliveries-AlOU95t5.js";import{E as de}from"./ErrorState-DbLmOyUk.js";function ce({hosts:i,value:o,onChange:l,disabled:p,isLoading:g,error:w}){const[h,b]=a.useState(""),[m,n]=a.useState(!1),k=a.useRef(null);a.useEffect(()=>{if(o){const r=i.find(v=>String(v.id)===String(o));r&&b(r.company)}else b("")},[o,i]),a.useEffect(()=>{function r(v){k.current&&!k.current.contains(v.target)&&n(!1)}return document.addEventListener("mousedown",r),()=>document.removeEventListener("mousedown",r)},[]);const u=i.some(r=>r.company===h&&String(r.id)===String(o)),f=h&&!u?i.filter(r=>r.company.toLowerCase().includes(h.toLowerCase())||r.name.toLowerCase().includes(h.toLowerCase())):i,y=r=>{l(String(r.id)),b(r.company),n(!1)},N=r=>{b(r.target.value),n(!0),r.target.value||l("")};return e.jsxs("div",{ref:k,className:"relative",children:[e.jsx("input",{type:"text",value:h,onChange:N,onFocus:()=>n(!0),placeholder:g?"Loading hosts...":"Search by company or host name...",disabled:p||g,className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${w?"border-red-300":"border-gray-300"}`}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),m&&f.length>0&&e.jsxs("ul",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:[f.slice(0,50).map(r=>e.jsxs("li",{onClick:()=>y(r),className:`px-3 py-2 cursor-pointer hover:bg-blue-50 text-sm ${String(r.id)===String(o)?"bg-blue-50 font-medium":""}`,children:[e.jsx("span",{children:r.company}),r.name!==r.company&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["— ",r.name]})]},r.id)),f.length>50&&e.jsxs("li",{className:"px-3 py-2 text-xs text-gray-400 text-center",children:["Type to narrow down ",f.length," results..."]})]}),m&&h&&f.length===0&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg px-3 py-3 text-sm text-gray-500 text-center",children:['No company found matching "',h,'"']})]})}const ue=Z({deliveryType:P().min(1,"Please select delivery type"),hostId:P().min(1,"Please select a host"),courier:P().min(1,"Please select a courier")});function me({onSubmit:i,isLoading:o}){var L,s,x;const[l,p]=a.useState([]),[g,w]=a.useState([]),[h,b]=a.useState([]),[m,n]=a.useState(!0);a.useEffect(()=>{Promise.all([te(),se(),re({page:1,limit:1e3})]).then(([t,d,j])=>{p(t),w(d),b(j.data||[])}).catch(()=>{p([]),w([]),b([])}).finally(()=>n(!1))},[]);const{handleSubmit:k,formState:{errors:u},reset:f,watch:y,setValue:N}=J({resolver:X(ue),defaultValues:{deliveryType:"",hostId:"",courier:""}}),r=y("deliveryType"),v=a.useMemo(()=>g.filter(t=>r==="Food"||r==="Gift"?t.category==="FOOD":t.category==="PARCEL"||!t.category),[g,r]),D=l.map(t=>({value:t.label,label:t.label})),M=v.map(t=>({value:t.label,label:t.label}));a.useEffect(()=>{const t=y("courier"),d=v.some(j=>j.label===t);t&&!d&&N("courier","")},[r]);const C=async t=>{await i(t),f()};return e.jsxs("form",{onSubmit:k(C),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deliveryType",className:"block text-sm font-medium text-gray-700 mb-1",children:"Type of Delivery *"}),e.jsx(R,{options:D,value:y("deliveryType")||"",onChange:t=>N("deliveryType",t,{shouldValidate:!0}),placeholder:m?"Loading...":"Type to search delivery type...",disabled:o||m,isLoading:m,error:(L=u.deliveryType)==null?void 0:L.message,emptyMessage:"No delivery type found"}),u.deliveryType&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.deliveryType.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Host *"}),e.jsx(ce,{hosts:h,value:y("hostId")||"",onChange:t=>N("hostId",t,{shouldValidate:!0}),disabled:o,isLoading:m,error:(s=u.hostId)==null?void 0:s.message}),u.hostId&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.hostId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"courier",className:"block text-sm font-medium text-gray-700 mb-1",children:"Courier *"}),e.jsx(R,{options:M,value:y("courier")||"",onChange:t=>N("courier",t,{shouldValidate:!0}),placeholder:m?"Loading...":r?"Type to search courier...":"Select delivery type first",disabled:o||m||!r,error:(x=u.courier)==null?void 0:x.message,emptyMessage:"No courier found"}),u.courier&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.courier.message})]}),e.jsx("button",{type:"submit",disabled:o||m,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 transition",children:o?"Saving...":"Record Delivery"})]})}const xe=["RECEIVED","PICKED_UP"];function he({deliveries:i,isLoading:o,pagination:l,onSearch:p,onStatusFilter:g,onPageChange:w,onEdit:h,onDelete:b,onMarkPickedUp:m}){const{user:n}=V(),k=(n==null?void 0:n.role)==="ADMIN",u=(n==null?void 0:n.role)==="ADMIN"||(n==null?void 0:n.role)==="RECEPTION",[f,y]=a.useState(""),[N,r]=a.useState(""),v=s=>{const x=s.target.value;y(x),p(x)},D=s=>{r(s),g(s)},M=()=>{l.page>1&&w(l.page-1)},C=()=>{l.page<l.totalPages&&w(l.page+1)},L=s=>s.status==="RECEIVED"||s.status==="PENDING";return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 space-y-4",children:[e.jsx("div",{children:e.jsx("input",{type:"text",placeholder:"Search by recipient, company, or description...",value:f,onChange:v,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Filter by Status"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>D(""),className:`px-3 py-1 rounded-full text-sm font-medium transition ${N===""?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"All"}),xe.map(s=>e.jsx("button",{onClick:()=>D(s),className:`px-3 py-1 rounded-full text-sm font-medium transition ${N===s?"bg-blue-600 text-white":`${H(s)} hover:opacity-80`}`,children:O(s)},s))]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Recipient"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Host Company"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Courier"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Received Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Actions"})]})}),e.jsx("tbody",{children:o?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})})})}):i.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500",children:"No deliveries found."})}):i.map(s=>{var x,t;return e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50 transition",children:[e.jsxs("td",{className:"px-6 py-4 text-sm",children:[e.jsx("div",{className:"text-gray-900 font-medium",children:s.recipient||"—"}),e.jsx("div",{className:"text-xs text-gray-500",children:((x=s.host)==null?void 0:x.name)||"—"})]}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:((t=s.host)==null?void 0:t.company)||"—"}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:s.courier||"—"}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:s.receivedAt?new Date(s.receivedAt).toLocaleDateString():"—"}),e.jsx("td",{className:"px-6 py-4 text-sm",children:e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${H(s.status)}`,children:O(s.status)})}),e.jsxs("td",{className:"px-6 py-4 text-sm space-x-1",children:[L(s)&&m&&e.jsx("button",{onClick:()=>m(s),className:"inline-flex items-center p-2 rounded-lg text-green-600 hover:bg-green-50 transition",title:"Mark Picked Up",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})}),u&&e.jsx("button",{onClick:()=>h(s),className:"inline-flex items-center p-2 rounded-lg text-blue-600 hover:bg-blue-50 transition",title:"Edit",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),k&&e.jsx("button",{onClick:()=>b(s),className:"inline-flex items-center p-2 rounded-lg text-red-600 hover:bg-red-50 transition",title:"Delete",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]},s.id)})})]})}),!o&&i.length>0&&e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Showing ",(l.page-1)*l.limit+1," to"," ",Math.min(l.page*l.limit,l.total)," of"," ",l.total," deliveries"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:M,disabled:l.page===1,className:"px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:text-gray-400 disabled:cursor-not-allowed transition",children:"Previous"}),e.jsx("div",{className:"flex items-center gap-1",children:(()=>{const s=l.page,x=l.totalPages,t=[];if(x<=7)for(let d=1;d<=x;d++)t.push(d);else{t.push(1),s>3&&t.push("...");for(let d=Math.max(2,s-1);d<=Math.min(x-1,s+1);d++)t.push(d);s<x-2&&t.push("..."),t.push(x)}return t.map((d,j)=>d==="..."?e.jsx("span",{className:"px-2 py-1 text-sm text-gray-500",children:"..."},`dots-${j}`):e.jsx("button",{onClick:()=>w(d),className:`px-3 py-1 rounded-lg text-sm font-medium transition ${d===s?"bg-blue-600 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:d},d))})()}),e.jsx("button",{onClick:C,disabled:l.page===l.totalPages,className:"px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:text-gray-400 disabled:cursor-not-allowed transition",children:"Next"})]})]})]})}function ye({isOpen:i,onClose:o,onSubmit:l,isLoading:p}){return a.useEffect(()=>(i?document.body.style.overflow="hidden":document.body.style.overflow="auto",()=>{document.body.style.overflow="auto"}),[i]),i?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40",onClick:o}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4 overflow-y-auto",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg max-w-md w-full my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Record New Delivery"}),e.jsx("button",{onClick:o,className:"text-gray-500 hover:text-gray-700","aria-label":"Close",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"px-6 py-4",children:e.jsx(me,{onSubmit:l,isLoading:p})})]})})]}):null}function pe({isOpen:i,delivery:o,onConfirm:l,onCancel:p,isLoading:g}){return a.useEffect(()=>(i?document.body.style.overflow="hidden":document.body.style.overflow="auto",()=>{document.body.style.overflow="auto"}),[i]),!i||!o?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40",onClick:p}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg max-w-sm w-full",children:[e.jsx("div",{className:"flex justify-center py-6",children:e.jsx("div",{className:"flex items-center justify-center w-12 h-12 rounded-full bg-red-100",children:e.jsx("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})}),e.jsxs("div",{className:"text-center px-6 pb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Delete Delivery Record"}),e.jsxs("p",{className:"text-gray-600 mb-2",children:["Are you sure you want to delete the delivery record for"," ",e.jsx("span",{className:"font-medium",children:o.recipientName}),"?"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"This action cannot be undone."})]}),e.jsxs("div",{className:"flex gap-2 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-lg",children:[e.jsx("button",{onClick:p,disabled:g,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-white disabled:bg-gray-100 transition",children:"Cancel"}),e.jsx("button",{onClick:l,disabled:g,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 disabled:bg-gray-400 transition",children:g?"Deleting...":"Delete"})]})]})})]})}function we(){const{success:i,error:o}=ee(),{user:l}=V(),p=(l==null?void 0:l.role)==="ADMIN"||(l==null?void 0:l.role)==="RECEPTION",[g,w]=a.useState([]),[h,b]=a.useState(!1),[m,n]=a.useState(null),[k,u]=a.useState(!1),[f,y]=a.useState(),[N,r]=a.useState(!1),[v,D]=a.useState(),[M,C]=a.useState(!1),[L,s]=a.useState(!1),[,x]=a.useState(!1),[t,d]=a.useState({page:1,limit:10,total:0,totalPages:1}),[j,z]=a.useState(""),[E,B]=a.useState(""),S=a.useCallback(async(c=1,I="",A="")=>{b(!0),n(null);try{const F={page:c,limit:t.limit};I&&(F.search=I),A&&(F.status=A);const T=await le(F);w(T.data||[]),d({page:T.page||1,limit:T.limit||10,total:T.total||0,totalPages:T.totalPages||1})}catch{n("Failed to load deliveries. Please check your connection and try again."),o("Failed to load deliveries")}finally{b(!1)}},[t.limit,o]);a.useEffect(()=>{S(1,"","")},[S]);const $=c=>{z(c),S(1,c,E)},W=c=>{B(c),S(1,j,c)},U=c=>{S(c,j,E)},Q=async c=>{s(!0);try{f?(await ae(f.id,c),i("Delivery updated successfully")):(await oe(c),i("Delivery recorded successfully")),u(!1),y(void 0),await S(t.page,j,E)}catch{o(f?"Failed to update delivery":"Failed to record delivery")}finally{s(!1)}},G=async c=>{x(!0);try{await ie(c.id),i("Delivery marked as picked up"),await S(t.page,j,E)}catch{o("Failed to mark delivery as picked up")}finally{x(!1)}},_=async()=>{if(v){C(!0);try{await ne(v.id),i("Delivery deleted successfully"),r(!1),D(void 0),await S(t.page,j,E)}catch{o("Failed to delete delivery")}finally{C(!1)}}},q=c=>{y(c),u(!0)},K=c=>{D(c),r(!0)},Y=()=>{u(!1),y(void 0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Deliveries Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Track and manage package deliveries"})]}),p&&e.jsx("button",{onClick:()=>{y(void 0),u(!0)},className:"px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Record Delivery"]})})]}),m&&!h&&e.jsx(de,{title:"Failed to load deliveries",message:m,onRetry:()=>S(t.page,j,E)}),!m&&e.jsx(he,{deliveries:g,isLoading:h,pagination:t,onSearch:$,onStatusFilter:W,onPageChange:U,onEdit:q,onDelete:K,onMarkPickedUp:G}),e.jsx(ye,{isOpen:k,onClose:Y,onSubmit:Q,isLoading:L}),e.jsx(pe,{isOpen:N,delivery:v,onConfirm:_,onCancel:()=>{r(!1),D(void 0)},isLoading:M})]})}export{we as default};
