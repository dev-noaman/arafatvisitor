import{r as i,j as e,c as Ne,t as ve,o as Se,s as J,_ as Y,a as we,u as Ce,g as Ie}from"./index-D0-OHiwP.js";import{a as W,b as se,c as ae,d as re,e as le,f as Ee,h as Te,i as Q,j as Ae,u as Re,k as De,l as Oe,r as Le}from"./tickets-BYYmzE0a.js";import{S as ee}from"./SearchableSelect-D63tGwCQ.js";import{b as Pe}from"./visitors-G7qqT13R.js";import{b as Fe}from"./deliveries-AlOU95t5.js";const te={custom:"custom"};function Me({tickets:t,isLoading:b,pagination:l,activeTab:p,onTabChange:g,onSearch:T,onStatusFilter:f,onPriorityFilter:S,onCategoryFilter:v,onPageChange:h,onTicketClick:A,adminUsers:C,onAssigneeFilter:w,onDateRangeFilter:c,dateFrom:I="",dateTo:E=""}){const[n,F]=i.useState(""),j=s=>{s.preventDefault(),T(n)},k=s=>new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),M=["OPEN","IN_PROGRESS","RESOLVED","CLOSED","REJECTED"],U=["SUBMITTED","REVIEWED","DISMISSED"];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex border-b border-gray-200",children:[e.jsx("button",{onClick:()=>g("COMPLAINT"),className:`px-4 py-2 text-sm font-medium border-b-2 -mb-px transition-colors ${p==="COMPLAINT"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Complaints"}),e.jsx("button",{onClick:()=>g("SUGGESTION"),className:`px-4 py-2 text-sm font-medium border-b-2 -mb-px transition-colors ${p==="SUGGESTION"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Suggestions"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("form",{onSubmit:j,className:"flex-1 min-w-[200px]",children:e.jsx("input",{type:"text",value:n,onChange:s=>F(s.target.value),placeholder:"Search by subject or ticket number...",className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),T(n))}})}),e.jsxs("select",{onChange:s=>f(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Statuses"}),(p==="COMPLAINT"?M:U).map(s=>e.jsx("option",{value:s,children:W(s)},s))]}),p==="COMPLAINT"&&e.jsxs(e.Fragment,{children:[e.jsxs("select",{onChange:s=>S(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Priorities"}),e.jsx("option",{value:"URGENT",children:"Urgent"}),e.jsx("option",{value:"HIGH",children:"High"}),e.jsx("option",{value:"MEDIUM",children:"Medium"}),e.jsx("option",{value:"LOW",children:"Low"})]}),e.jsxs("select",{onChange:s=>v(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Categories"}),e.jsx("option",{value:"IT_ISSUE",children:"IT Issue"}),e.jsx("option",{value:"FACILITY_ISSUE",children:"Facility Issue"}),e.jsx("option",{value:"VISITOR_SYSTEM_BUG",children:"Visitor System Bug"}),e.jsx("option",{value:"SERVICE_QUALITY",children:"Service Quality"}),e.jsx("option",{value:"OTHER",children:"Other"})]}),C&&C.length>0&&w&&e.jsxs("select",{onChange:s=>w(s.target.value?Number(s.target.value):""),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Assignees"}),C.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),c&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:I,onChange:s=>c(s.target.value,E),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",title:"From date"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"to"}),e.jsx("input",{type:"date",value:E,onChange:s=>c(I,s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",title:"To date"})]})]}),e.jsx("div",{className:"overflow-x-auto bg-white rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Ticket #"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Subject"}),p==="COMPLAINT"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Category"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Priority"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Assigned To"})]}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Created By"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:b?e.jsx("tr",{children:e.jsx("td",{colSpan:p==="COMPLAINT"?8:5,className:"px-4 py-8 text-center text-sm text-gray-500",children:"Loading..."})}):t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:p==="COMPLAINT"?8:5,className:"px-4 py-8 text-center text-sm text-gray-500",children:"No tickets found."})}):t.map(s=>{var o;return e.jsxs("tr",{onClick:()=>A(s),className:"hover:bg-gray-50 cursor-pointer",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-mono text-gray-900",children:s.ticketNumber}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 max-w-[200px] truncate",children:s.subject}),p==="COMPLAINT"&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:se(s.category)}),e.jsx("td",{className:"px-4 py-3",children:s.priority&&e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${re(s.priority)}`,children:ae(s.priority)})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:((o=s.assignedTo)==null?void 0:o.name)||e.jsx("span",{className:"text-gray-400",children:"Unassigned"})})]}),e.jsxs("td",{className:"px-4 py-3 text-sm text-gray-600",children:[s.createdBy.name,e.jsx("span",{className:`ml-1.5 text-[10px] font-medium px-1 py-0.5 rounded ${s.createdBy.role==="ADMIN"?"bg-red-100 text-red-700":s.createdBy.role==="HOST"?"bg-green-100 text-green-700":s.createdBy.role==="RECEPTION"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700"}`,children:s.createdBy.role})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${le(s.status)}`,children:W(s.status)})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:k(s.createdAt)})]},s.id)})})]})}),l.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",(l.page-1)*l.limit+1," to"," ",Math.min(l.page*l.limit,l.total)," of ",l.total]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>h(l.page-1),disabled:l.page<=1,className:"px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Previous"}),Array.from({length:Math.min(5,l.totalPages)},(s,o)=>{let d;return l.totalPages<=5||l.page<=3?d=o+1:l.page>=l.totalPages-2?d=l.totalPages-4+o:d=l.page-2+o,e.jsx("button",{onClick:()=>h(d),className:`px-3 py-1.5 text-sm border rounded-md ${d===l.page?"bg-blue-600 text-white border-blue-600":"border-gray-300 hover:bg-gray-50"}`,children:d},d)}),e.jsx("button",{onClick:()=>h(l.page+1),disabled:l.page>=l.totalPages,className:"px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Next"})]})]})]})}function Ue({comments:t,onAddComment:b,isAdmin:l,isLoading:p}){const[g,T]=i.useState(""),[f,S]=i.useState(!1),[v,h]=i.useState(!1),A=async c=>{if(c.preventDefault(),!!g.trim()){h(!0);try{await b(g.trim(),l?f:!1),T(""),S(!1)}finally{h(!1)}}},C=c=>new Date(c).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}),w=c=>{if(!c)return null;const I={ADMIN:"bg-red-100 text-red-700",RECEPTION:"bg-blue-100 text-blue-700",HOST:"bg-green-100 text-green-700",STAFF:"bg-purple-100 text-purple-700"};return e.jsx("span",{className:`text-[10px] font-medium px-1.5 py-0.5 rounded ${I[c]||"bg-gray-100 text-gray-700"}`,children:c})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900",children:["Comments (",t.length,")"]}),t.length===0?e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No comments yet."}):e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:t.map(c=>e.jsxs("div",{className:`p-3 rounded-lg text-sm ${c.isInternal?"bg-amber-50 border border-amber-200":"bg-gray-50 border border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:c.user.name}),w(c.user.role),c.isInternal&&e.jsx("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded bg-amber-100 text-amber-700",children:"Internal Note"}),e.jsx("span",{className:"text-xs text-gray-500 ml-auto",children:C(c.createdAt)})]}),e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:c.message})]},c.id))}),!p&&e.jsxs("form",{onSubmit:A,className:"space-y-2",children:[e.jsx("textarea",{value:g,onChange:c=>T(c.target.value),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Write a comment..."}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:l&&e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:c=>S(c.target.checked),className:"rounded border-gray-300"}),"Internal note (hidden from ticket creator)"]})}),e.jsx("button",{type:"submit",disabled:!g.trim()||v,className:"px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Sending...":"Send"})]})]})]})}const ke={OPEN:["IN_PROGRESS","REJECTED"],IN_PROGRESS:["RESOLVED","REJECTED"],RESOLVED:["CLOSED"]},Ge={SUBMITTED:["REVIEWED","DISMISSED"]};function Be({ticket:t,isAdmin:b,currentUserId:l,adminUsers:p,onUpdate:g,onAddComment:T,onReopen:f,onBack:S}){var y,$,L;const[v,h]=i.useState(!1),[A,C]=i.useState(""),[w,c]=i.useState(""),[I,E]=i.useState(!1),[n,F]=i.useState(""),j=t.type==="COMPLAINT",M=t.createdBy.id===l&&j&&t.status==="RESOLVED",U=j?ke[t.status]||[]:Ge[t.status]||[],s=a=>a?new Date(a).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—",o=async a=>{if(a==="RESOLVED"&&!A.trim()){alert("Resolution text is required");return}if(a==="REJECTED"&&!w.trim()){alert("Rejection reason is required");return}h(!0);try{const N={status:a,updatedAt:t.updatedAt};a==="RESOLVED"&&(N.resolution=A),a==="REJECTED"&&(N.rejectionReason=w),await g(N),C(""),c("")}finally{h(!1)}},d=async a=>{h(!0);try{await g({assignedToId:a,updatedAt:t.updatedAt})}finally{h(!1)}},R=async a=>{h(!0);try{await g({priority:a,updatedAt:t.updatedAt})}finally{h(!1)}},x=async()=>{if(n.trim()){h(!0);try{await f(n),F(""),E(!1)}finally{h(!1)}}},D=async(a,N)=>{try{const H=await Ee(t.id,a),O=URL.createObjectURL(H),V=document.createElement("a");V.href=O,V.download=N,V.click(),URL.revokeObjectURL(O)}catch{alert("Failed to download attachment")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{children:[e.jsx("button",{onClick:S,className:"text-sm text-blue-600 hover:text-blue-800 mb-2",children:"← Back to list"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:t.ticketNumber}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${j?"bg-orange-100 text-orange-800":"bg-purple-100 text-purple-800"}`,children:j?"Complaint":"Suggestion"}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${le(t.status)}`,children:W(t.status)}),j&&t.priority&&e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${re(t.priority)}`,children:ae(t.priority)})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:t.subject}),e.jsx("p",{className:"text-sm text-gray-700 whitespace-pre-wrap",children:t.description})]}),t.resolution&&e.jsxs("div",{className:"bg-green-50 rounded-lg border border-green-200 p-5",children:[e.jsx("h4",{className:"text-sm font-semibold text-green-800 mb-1",children:"Resolution"}),e.jsx("p",{className:"text-sm text-green-700 whitespace-pre-wrap",children:t.resolution}),t.resolvedAt&&e.jsxs("p",{className:"text-xs text-green-600 mt-2",children:["Resolved by ",((y=t.assignedTo)==null?void 0:y.name)||"Admin"," on ",s(t.resolvedAt)]})]}),t.rejectionReason&&e.jsxs("div",{className:"bg-red-50 rounded-lg border border-red-200 p-5",children:[e.jsx("h4",{className:"text-sm font-semibold text-red-800 mb-1",children:"Rejection Reason"}),e.jsx("p",{className:"text-sm text-red-700 whitespace-pre-wrap",children:t.rejectionReason})]}),t.attachments&&t.attachments.length>0&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:["Attachments (",t.attachments.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:t.attachments.map(a=>e.jsxs("div",{onClick:()=>D(a.id,a.fileName),className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-100",children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center bg-blue-100 rounded text-blue-600 text-xs font-bold",children:a.mimeType.includes("pdf")?"PDF":"IMG"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:a.fileName}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(a.fileSize/1024).toFixed(0)," KB"]})]})]},a.id))})]}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:e.jsx(Ue,{comments:t.comments||[],onAddComment:T,isAdmin:b})}),M&&!I&&e.jsx("button",{onClick:()=>E(!0),className:"px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700",children:"Reopen Ticket"}),I&&e.jsxs("div",{className:"bg-yellow-50 rounded-lg border border-yellow-200 p-5 space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-yellow-800",children:"Reopen this complaint"}),e.jsx("textarea",{value:n,onChange:a=>F(a.target.value),rows:3,className:"w-full px-3 py-2 border border-yellow-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500",placeholder:"Explain why you want to reopen this ticket..."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:x,disabled:!n.trim()||v,className:"px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700 disabled:opacity-50",children:v?"Reopening...":"Confirm Reopen"}),e.jsx("button",{onClick:()=>{E(!1),F("")},className:"px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300",children:"Cancel"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Created By"}),e.jsx("p",{className:"text-sm text-gray-900",children:t.createdBy.name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.createdBy.role})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Created"}),e.jsx("p",{className:"text-sm text-gray-900",children:s(t.createdAt)})]}),j&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Category"}),e.jsx("p",{className:"text-sm text-gray-900",children:se(t.category)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Assigned To"}),e.jsx("p",{className:"text-sm text-gray-900",children:(($=t.assignedTo)==null?void 0:$.name)||"Unassigned"})]})]}),t.relatedVisit&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Related Visit"}),e.jsx("p",{className:"text-sm text-gray-900",children:t.relatedVisit.sessionId})]}),t.relatedDelivery&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Related Delivery"}),e.jsxs("p",{className:"text-sm text-gray-900",children:["#",t.relatedDelivery.id]})]}),t.closedAt&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Closed"}),e.jsx("p",{className:"text-sm text-gray-900",children:s(t.closedAt)})]})]}),b&&U.length>0&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Admin Actions"}),j&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Assign To"}),e.jsxs("select",{value:((L=t.assignedTo)==null?void 0:L.id)||"",onChange:a=>d(a.target.value?Number(a.target.value):null),disabled:v,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",children:[e.jsx("option",{value:"",children:"Unassigned"}),p.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),j&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Priority"}),e.jsxs("select",{value:t.priority||"",onChange:a=>R(a.target.value),disabled:v,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",children:[e.jsx("option",{value:"LOW",children:"Low"}),e.jsx("option",{value:"MEDIUM",children:"Medium"}),e.jsx("option",{value:"HIGH",children:"High"}),e.jsx("option",{value:"URGENT",children:"Urgent"})]})]}),U.includes("RESOLVED")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Resolution *"}),e.jsx("textarea",{value:A,onChange:a=>C(a.target.value),rows:3,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",placeholder:"Describe how this was resolved..."})]}),U.includes("REJECTED")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Rejection Reason"}),e.jsx("textarea",{value:w,onChange:a=>c(a.target.value),rows:2,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",placeholder:"Reason for rejection..."})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:U.map(a=>{const N={IN_PROGRESS:"bg-indigo-600 hover:bg-indigo-700",RESOLVED:"bg-green-600 hover:bg-green-700",CLOSED:"bg-gray-600 hover:bg-gray-700",REJECTED:"bg-red-600 hover:bg-red-700",REVIEWED:"bg-green-600 hover:bg-green-700",DISMISSED:"bg-gray-600 hover:bg-gray-700"};return e.jsx("button",{onClick:()=>o(a),disabled:v,className:`px-3 py-1.5 text-white text-sm font-medium rounded-md disabled:opacity-50 ${N[a]||"bg-blue-600 hover:bg-blue-700"}`,children:v?"...":W(a)},a)})})]})]})]})]})}const Ve=Se({type:Y(["SUGGESTION","COMPLAINT"]),subject:J().min(3,"Subject must be at least 3 characters").max(200,"Subject cannot exceed 200 characters"),description:J().min(10,"Description must be at least 10 characters"),category:Y(["IT_ISSUE","FACILITY_ISSUE","VISITOR_SYSTEM_BUG","SERVICE_QUALITY","OTHER"]).optional(),priority:Y(["LOW","MEDIUM","HIGH","URGENT"]).optional(),relatedVisitId:J().optional(),relatedDeliveryId:J().optional()}).superRefine((t,b)=>{t.type==="COMPLAINT"&&(t.category||b.addIssue({code:te.custom,message:"Category is required for complaints",path:["category"]}),t.priority||b.addIssue({code:te.custom,message:"Priority is required for complaints",path:["priority"]}))});function $e({onSubmit:t,isLoading:b}){const[l,p]=i.useState("type"),[g,T]=i.useState([]),[f,S]=i.useState([]),[v,h]=i.useState([]),[A,C]=i.useState(!1),{register:w,handleSubmit:c,watch:I,setValue:E,formState:{errors:n},reset:F}=Ne({resolver:ve(Ve),defaultValues:{type:void 0,subject:"",description:""}}),j=I("type");i.useEffect(()=>{if(j!=="COMPLAINT")return;let o=!1;return C(!0),Promise.all([Pe({limit:200,sortBy:"createdAt",sortOrder:"desc"}).catch(()=>null),Fe({limit:200,sortBy:"createdAt",sortOrder:"desc"}).catch(()=>null)]).then(([d,R])=>{o||(d!=null&&d.data&&S(d.data.map(x=>{var D,y;return{value:String(x.id),label:`${x.sessionId||x.id} — ${((D=x.visitor)==null?void 0:D.name)||x.visitorName||"Unknown"} (${((y=x.host)==null?void 0:y.name)||"N/A"})`}})),R!=null&&R.data&&h(R.data.map(x=>{var D;return{value:String(x.id),label:`#${x.id} — ${x.recipient||x.recipientName||"Unknown"} (${((D=x.host)==null?void 0:D.name)||"N/A"})`}})))}).finally(()=>{o||C(!1)}),()=>{o=!0}},[j]);const k=o=>{E("type",o),p("form")},M=o=>{const d=o.target.files;if(!d)return;const R=Array.from(d),x=[];for(const y of R){if(y.size>5*1024*1024){alert(`${y.name} exceeds 5MB limit`);continue}if(!["image/jpeg","image/png","application/pdf"].includes(y.type)){alert(`${y.name} is not a supported file type (JPEG, PNG, PDF only)`);continue}x.push(y)}const D=[...g,...x].slice(0,3);T(D),o.target.value=""},U=o=>{T(d=>d.filter((R,x)=>x!==o))},s=async o=>{await t(o,g),F(),T([]),p("type")};return l==="type"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"What type of ticket would you like to create?"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>k("SUGGESTION"),className:"p-4 border-2 border-gray-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-colors text-left",children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Suggestion"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Share an idea or feedback"})]}),e.jsxs("button",{type:"button",onClick:()=>k("COMPLAINT"),className:"p-4 border-2 border-gray-200 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition-colors text-left",children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Complaint"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Report an issue that needs resolution"})]})]})]}):e.jsxs("form",{onSubmit:c(s),className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("button",{type:"button",onClick:()=>{p("type"),F()},className:"text-sm text-blue-600 hover:text-blue-800",children:"← Change type"}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${j==="SUGGESTION"?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800"}`,children:j==="SUGGESTION"?"Suggestion":"Complaint"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Subject *"}),e.jsx("input",{...w("subject"),type:"text",className:`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${n.subject?"border-red-300":"border-gray-300"}`,placeholder:"Brief summary of your ticket"}),n.subject&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:n.subject.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description *"}),e.jsx("textarea",{...w("description"),rows:4,className:`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${n.description?"border-red-300":"border-gray-300"}`,placeholder:"Provide detailed information..."}),n.description&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:n.description.message})]}),j==="COMPLAINT"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category *"}),e.jsxs("select",{...w("category"),className:`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${n.category?"border-red-300":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"Select category"}),e.jsx("option",{value:"IT_ISSUE",children:"IT Issue"}),e.jsx("option",{value:"FACILITY_ISSUE",children:"Facility Issue"}),e.jsx("option",{value:"VISITOR_SYSTEM_BUG",children:"Visitor System Bug"}),e.jsx("option",{value:"SERVICE_QUALITY",children:"Service Quality"}),e.jsx("option",{value:"OTHER",children:"Other"})]}),n.category&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:n.category.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priority *"}),e.jsxs("select",{...w("priority"),className:`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${n.priority?"border-red-300":"border-gray-300"}`,children:[e.jsx("option",{value:"",children:"Select priority"}),e.jsx("option",{value:"LOW",children:"Low"}),e.jsx("option",{value:"MEDIUM",children:"Medium"}),e.jsx("option",{value:"HIGH",children:"High"}),e.jsx("option",{value:"URGENT",children:"Urgent"})]}),n.priority&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:n.priority.message})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Related Visit"}),e.jsx(ee,{options:f,value:I("relatedVisitId")||"",onChange:o=>E("relatedVisitId",o||void 0),placeholder:"Search visits...",isLoading:A,emptyMessage:"No visits found"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Related Delivery"}),e.jsx(ee,{options:v,value:I("relatedDeliveryId")||"",onChange:o=>E("relatedDeliveryId",o||void 0),placeholder:"Search deliveries...",isLoading:A,emptyMessage:"No deliveries found"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Attachments (",g.length,"/3)"]}),g.length<3&&e.jsx("input",{type:"file",onChange:M,accept:"image/jpeg,image/png,application/pdf",className:"block w-full text-sm text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"}),g.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:g.map((o,d)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 px-3 py-1.5 rounded text-sm",children:[e.jsxs("span",{className:"truncate",children:[o.name," (",(o.size/1024).toFixed(0)," KB)"]}),e.jsx("button",{type:"button",onClick:()=>U(d),className:"text-red-500 hover:text-red-700 ml-2",children:"×"})]},d))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Max 3 files, 5MB each. JPEG, PNG, or PDF."})]})]}),e.jsx("div",{className:"flex justify-end gap-3 pt-2",children:e.jsx("button",{type:"submit",disabled:b,className:"px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:b?"Submitting...":"Submit Ticket"})})]})}function _e({isOpen:t,onClose:b,onSubmit:l,isLoading:p}){return i.useEffect(()=>(t?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[t]),t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 z-40",onClick:b}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-start justify-center overflow-y-auto p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-lg my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"New Ticket"}),e.jsx("button",{onClick:b,className:"text-gray-400 hover:text-gray-600 text-xl leading-none",children:"×"})]}),e.jsx("div",{className:"px-5 py-4",children:e.jsx($e,{onSubmit:l,isLoading:p})})]})})]}):null}function ze(){const{user:t}=we(),{success:b,error:l}=Ce(),p=(t==null?void 0:t.role)==="ADMIN",[g,T]=i.useState([]),[f,S]=i.useState(null),[v,h]=i.useState([]),[A,C]=i.useState(!1),[w,c]=i.useState(!1),[I,E]=i.useState(!1),[n,F]=i.useState("COMPLAINT"),[j,k]=i.useState("list"),[M,U]=i.useState({page:1,limit:10,total:0,totalPages:1}),[s,o]=i.useState(""),[d,R]=i.useState(""),[x,D]=i.useState(""),[y,$]=i.useState(""),[L,a]=i.useState(""),[N,H]=i.useState(""),[O,V]=i.useState(""),P=i.useCallback(async(r=1,m="",u=n,B="",z="",q="",K="",X="",Z="")=>{C(!0);try{const G={page:r,limit:M.limit,type:u,sortBy:u==="COMPLAINT"?"priority":"createdAt",sortOrder:"desc"};m&&(G.search=m),B&&(G.status=B),z&&(G.priority=z),q&&(G.category=q),K&&(G.assignedToId=K),X&&(G.dateFrom=X),Z&&(G.dateTo=Z);const _=await Te(G);T(_.data||[]),U({page:_.page||1,limit:_.limit||10,total:_.total||0,totalPages:_.totalPages||1})}catch{l("Failed to load tickets")}finally{C(!1)}},[n,M.limit,l]),ne=i.useCallback(async()=>{if(p)try{const r=await Ie("/admin/api/users?role=ADMIN&limit=100");Array.isArray(r)?h(r.map(m=>({id:Number(m.id),name:m.name||m.email}))):r!=null&&r.data&&h(r.data.map(m=>({id:Number(m.id),name:m.name||m.email})))}catch{}},[p]);i.useEffect(()=>{P(1,"",n),ne()},[]);const ie=r=>{F(r),o(""),R(""),D(""),$(""),a(""),H(""),V(""),P(1,"",r,"","","","","","")},oe=r=>{o(r),P(1,r,n,d,x,y,L,N,O)},de=r=>{R(r),P(1,s,n,r,x,y,L,N,O)},ce=r=>{D(r),P(1,s,n,d,r,y,L,N,O)},xe=r=>{$(r),P(1,s,n,d,x,r,L,N,O)},me=r=>{a(r),P(1,s,n,d,x,y,r,N,O)},ue=(r,m)=>{H(r),V(m),P(1,s,n,d,x,y,L,r,m)},pe=r=>{P(r,s,n,d,x,y,L,N,O)},ge=async r=>{try{const m=await Q(r.id);S(m),k("detail")}catch{l("Failed to load ticket details")}},he=async(r,m)=>{c(!0);try{const u=await Ae(r);for(const B of m)try{await Re(u.id,B)}catch{l(`Failed to upload ${B.name}`)}b(`Ticket ${u.ticketNumber} created successfully`),E(!1),P(1,s,n,d,x,y,L,N,O)}catch(u){l((u==null?void 0:u.message)||"Failed to create ticket")}finally{c(!1)}},ye=async r=>{var m;if(f)try{const u=await De(f.id,r);S(u),b("Ticket updated successfully")}catch(u){if((u==null?void 0:u.statusCode)===409||(m=u==null?void 0:u.message)!=null&&m.includes("modified")){l("This ticket was modified by another user. Please refresh.");const B=await Q(f.id);S(B)}else l((u==null?void 0:u.message)||"Failed to update ticket")}},be=async(r,m)=>{if(f)try{await Oe(f.id,{message:r,isInternal:m});const u=await Q(f.id);S(u)}catch{l("Failed to add comment")}},fe=async r=>{if(f)try{const m=await Le(f.id,r);S(m),b("Ticket reopened successfully")}catch(m){l((m==null?void 0:m.message)||"Failed to reopen ticket")}},je=()=>{k("list"),S(null),P(M.page,s,n,d,x,y,L,N,O)};return e.jsxs("div",{className:"p-6",children:[j==="list"&&e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Tickets"}),e.jsx("button",{onClick:()=>E(!0),className:"px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700",children:"New Ticket"})]}),j==="list"?e.jsx(Me,{tickets:g,isLoading:A,pagination:M,activeTab:n,onTabChange:ie,onSearch:oe,onStatusFilter:de,onPriorityFilter:ce,onCategoryFilter:xe,onPageChange:pe,onTicketClick:ge,adminUsers:v,onAssigneeFilter:me,onDateRangeFilter:ue,dateFrom:N,dateTo:O}):f?e.jsx(Be,{ticket:f,isAdmin:p,currentUserId:Number(t==null?void 0:t.id)||0,adminUsers:v,onUpdate:ye,onAddComment:be,onReopen:fe,onBack:je}):null,e.jsx(_e,{isOpen:I,onClose:()=>E(!1),onSubmit:he,isLoading:w})]})}export{ze as default};
