import{r as n,j as e,a as _,c as te,d as se,o as ae,s as V,_ as re,u as le}from"./index-KOxzgtUP.js";import{a as B,b as J,d as ne,c as oe,e as G,f as de,u as ce,h as ie,i as me,r as xe}from"./tickets-BkEpeXHs.js";function ue({tickets:t,isLoading:g,pagination:a,activeTab:h,onTabChange:f,onSearch:b,onStatusFilter:m,onPageChange:x,onTicketClick:v,onDateRangeFilter:j,dateFrom:C="",dateTo:p=""}){const[S,r]=n.useState(""),d=s=>{s.preventDefault(),b(S)},R=s=>new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),D=["OPEN","IN_PROGRESS","RESOLVED","CLOSED","REJECTED"],w=["SUBMITTED","REVIEWED","DISMISSED"];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex border-b border-gray-200",children:[e.jsx("button",{onClick:()=>f("COMPLAINT"),className:`px-4 py-2 text-sm font-medium border-b-2 -mb-px transition-colors ${h==="COMPLAINT"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Complaints"}),e.jsx("button",{onClick:()=>f("SUGGESTION"),className:`px-4 py-2 text-sm font-medium border-b-2 -mb-px transition-colors ${h==="SUGGESTION"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Suggestions"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("form",{onSubmit:d,className:"flex-1 min-w-[200px]",children:e.jsx("input",{type:"text",value:S,onChange:s=>r(s.target.value),placeholder:"Search by subject or ticket number...",className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),b(S))}})}),e.jsxs("select",{onChange:s=>m(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Statuses"}),(h==="COMPLAINT"?D:w).map(s=>e.jsx("option",{value:s,children:B(s)},s))]}),j&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:C,onChange:s=>j(s.target.value,p),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",title:"From date"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"to"}),e.jsx("input",{type:"date",value:p,onChange:s=>j(C,s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",title:"To date"})]})]}),e.jsx("div",{className:"overflow-x-auto bg-white rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Ticket #"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Subject"}),h==="COMPLAINT"&&e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Host"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Created By"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:g?e.jsx("tr",{children:e.jsx("td",{colSpan:h==="COMPLAINT"?7:5,className:"px-4 py-8 text-center text-sm text-gray-500",children:"Loading..."})}):t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:h==="COMPLAINT"?7:5,className:"px-4 py-8 text-center text-sm text-gray-500",children:"No tickets found."})}):t.map(s=>e.jsxs("tr",{onClick:()=>v(s),className:"hover:bg-gray-50 cursor-pointer",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-mono text-gray-900",children:s.ticketNumber}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 max-w-[200px] truncate",children:s.subject}),h==="COMPLAINT"&&e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.host?`${s.host.name} (${s.host.company})`:e.jsx("span",{className:"text-gray-400",children:"—"})}),e.jsxs("td",{className:"px-4 py-3 text-sm text-gray-600",children:[s.createdBy.name,e.jsx("span",{className:`ml-1.5 text-[10px] font-medium px-1 py-0.5 rounded ${s.createdBy.role==="ADMIN"?"bg-red-100 text-red-700":s.createdBy.role==="HOST"?"bg-green-100 text-green-700":s.createdBy.role==="RECEPTION"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700"}`,children:s.createdBy.role})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${J(s.status)}`,children:B(s.status)})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:R(s.createdAt)})]},s.id))})]})}),a.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",(a.page-1)*a.limit+1," to"," ",Math.min(a.page*a.limit,a.total)," of ",a.total]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>x(a.page-1),disabled:a.page<=1,className:"px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Previous"}),Array.from({length:Math.min(5,a.totalPages)},(s,y)=>{let c;return a.totalPages<=5||a.page<=3?c=y+1:a.page>=a.totalPages-2?c=a.totalPages-4+y:c=a.page-2+y,e.jsx("button",{onClick:()=>x(c),className:`px-3 py-1.5 text-sm border rounded-md ${c===a.page?"bg-blue-600 text-white border-blue-600":"border-gray-300 hover:bg-gray-50"}`,children:c},c)}),e.jsx("button",{onClick:()=>x(a.page+1),disabled:a.page>=a.totalPages,className:"px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Next"})]})]})]})}function pe({comments:t,onAddComment:g,isAdmin:a,isLoading:h}){const[f,b]=n.useState(""),[m,x]=n.useState(!1),[v,j]=n.useState(!1),C=async r=>{if(r.preventDefault(),!!f.trim()){j(!0);try{await g(f.trim(),a?m:!1),b(""),x(!1)}finally{j(!1)}}},p=r=>new Date(r).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}),S=r=>{if(!r)return null;const d={ADMIN:"bg-red-100 text-red-700",RECEPTION:"bg-blue-100 text-blue-700",HOST:"bg-green-100 text-green-700",STAFF:"bg-purple-100 text-purple-700"};return e.jsx("span",{className:`text-[10px] font-medium px-1.5 py-0.5 rounded ${d[r]||"bg-gray-100 text-gray-700"}`,children:r})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900",children:["Comments (",t.length,")"]}),t.length===0?e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No comments yet."}):e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:t.map(r=>e.jsxs("div",{className:`p-3 rounded-lg text-sm ${r.isInternal?"bg-amber-50 border border-amber-200":"bg-gray-50 border border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:r.user.name}),S(r.user.role),r.isInternal&&e.jsx("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded bg-amber-100 text-amber-700",children:"Internal Note"}),e.jsx("span",{className:"text-xs text-gray-500 ml-auto",children:p(r.createdAt)})]}),e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:r.message})]},r.id))}),!h&&e.jsxs("form",{onSubmit:C,className:"space-y-2",children:[e.jsx("textarea",{value:f,onChange:r=>b(r.target.value),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Write a comment..."}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:a&&e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx("input",{type:"checkbox",checked:m,onChange:r=>x(r.target.checked),className:"rounded border-gray-300"}),"Internal note (hidden from ticket creator)"]})}),e.jsx("button",{type:"submit",disabled:!f.trim()||v,className:"px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Sending...":"Send"})]})]})]})}const he={OPEN:["IN_PROGRESS","REJECTED"],IN_PROGRESS:["RESOLVED","REJECTED"],RESOLVED:["CLOSED"]},ge={SUBMITTED:["REVIEWED","DISMISSED"]};function be({ticket:t,isAdmin:g,currentUserId:a,onUpdate:h,onAddComment:f,onReopen:b,onBack:m}){const[x,v]=n.useState(!1),[j,C]=n.useState(""),[p,S]=n.useState(""),[r,d]=n.useState(!1),[R,D]=n.useState(""),w=t.type==="COMPLAINT",y=t.createdBy.id===a&&w&&t.status==="RESOLVED",c=w?he[t.status]||[]:ge[t.status]||[],E=l=>l?new Date(l).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—",O=async l=>{if(l==="RESOLVED"&&!j.trim()){alert("Resolution text is required");return}if(l==="REJECTED"&&!p.trim()){alert("Rejection reason is required");return}v(!0);try{const N={status:l,updatedAt:t.updatedAt};l==="RESOLVED"&&(N.resolution=j),l==="REJECTED"&&(N.rejectionReason=p),await h(N),C(""),S("")}finally{v(!1)}},I=async()=>{if(R.trim()){v(!0);try{await b(R),D(""),d(!1)}finally{v(!1)}}},A=async(l,N)=>{try{const M=await ne(t.id,l),T=URL.createObjectURL(M),F=document.createElement("a");F.href=T,F.download=N,F.click(),URL.revokeObjectURL(T)}catch{alert("Failed to download attachment")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{children:[e.jsx("button",{onClick:m,className:"text-sm text-blue-600 hover:text-blue-800 mb-2",children:"← Back to list"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:t.ticketNumber}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${w?"bg-orange-100 text-orange-800":"bg-purple-100 text-purple-800"}`,children:w?"Complaint":"Suggestion"}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${J(t.status)}`,children:B(t.status)}),w&&t.host&&e.jsxs("span",{className:"text-xs text-gray-600",children:[t.host.name," (",t.host.company,")"]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:t.subject}),e.jsx("p",{className:"text-sm text-gray-700 whitespace-pre-wrap",children:t.description})]}),t.resolution&&e.jsxs("div",{className:"bg-green-50 rounded-lg border border-green-200 p-5",children:[e.jsx("h4",{className:"text-sm font-semibold text-green-800 mb-1",children:"Resolution"}),e.jsx("p",{className:"text-sm text-green-700 whitespace-pre-wrap",children:t.resolution}),t.resolvedAt&&e.jsxs("p",{className:"text-xs text-green-600 mt-2",children:["Resolved on ",E(t.resolvedAt)]})]}),t.rejectionReason&&e.jsxs("div",{className:"bg-red-50 rounded-lg border border-red-200 p-5",children:[e.jsx("h4",{className:"text-sm font-semibold text-red-800 mb-1",children:"Rejection Reason"}),e.jsx("p",{className:"text-sm text-red-700 whitespace-pre-wrap",children:t.rejectionReason})]}),t.attachments&&t.attachments.length>0&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:["Attachments (",t.attachments.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:t.attachments.map(l=>e.jsxs("div",{onClick:()=>A(l.id,l.fileName),className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-100",children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center bg-blue-100 rounded text-blue-600 text-xs font-bold",children:l.mimeType.includes("pdf")?"PDF":"IMG"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:l.fileName}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(l.fileSize/1024).toFixed(0)," KB"]})]})]},l.id))})]}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:e.jsx(pe,{comments:t.comments||[],onAddComment:f,isAdmin:g})}),y&&!r&&e.jsx("button",{onClick:()=>d(!0),className:"px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700",children:"Reopen Ticket"}),r&&e.jsxs("div",{className:"bg-yellow-50 rounded-lg border border-yellow-200 p-5 space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-yellow-800",children:"Reopen this complaint"}),e.jsx("textarea",{value:R,onChange:l=>D(l.target.value),rows:3,className:"w-full px-3 py-2 border border-yellow-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500",placeholder:"Explain why you want to reopen this ticket..."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:I,disabled:!R.trim()||x,className:"px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700 disabled:opacity-50",children:x?"Reopening...":"Confirm Reopen"}),e.jsx("button",{onClick:()=>{d(!1),D("")},className:"px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300",children:"Cancel"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Created By"}),e.jsx("p",{className:"text-sm text-gray-900",children:t.createdBy.name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.createdBy.role})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Created"}),e.jsx("p",{className:"text-sm text-gray-900",children:E(t.createdAt)})]}),w&&e.jsx(e.Fragment,{children:t.host&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Host / Company"}),e.jsxs("p",{className:"text-sm text-gray-900",children:[t.host.name," (",t.host.company,")"]})]})}),t.closedAt&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Closed"}),e.jsx("p",{className:"text-sm text-gray-900",children:E(t.closedAt)})]})]}),g&&c.length>0&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Admin Actions"}),c.includes("RESOLVED")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Resolution *"}),e.jsx("textarea",{value:j,onChange:l=>C(l.target.value),rows:3,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",placeholder:"Describe how this was resolved..."})]}),c.includes("REJECTED")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Rejection Reason"}),e.jsx("textarea",{value:p,onChange:l=>S(l.target.value),rows:2,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",placeholder:"Reason for rejection..."})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:c.map(l=>{const N={IN_PROGRESS:"bg-indigo-600 hover:bg-indigo-700",RESOLVED:"bg-green-600 hover:bg-green-700",CLOSED:"bg-gray-600 hover:bg-gray-700",REJECTED:"bg-red-600 hover:bg-red-700",REVIEWED:"bg-green-600 hover:bg-green-700",DISMISSED:"bg-gray-600 hover:bg-gray-700"};return e.jsx("button",{onClick:()=>O(l),disabled:x,className:`px-3 py-1.5 text-white text-sm font-medium rounded-md disabled:opacity-50 ${N[l]||"bg-blue-600 hover:bg-blue-700"}`,children:x?"...":B(l)},l)})})]})]})]})]})}const ye=ae({type:re(["SUGGESTION","COMPLAINT"]),subject:V().min(3,"Subject must be at least 3 characters").max(200,"Subject cannot exceed 200 characters"),description:V().min(10,"Description must be at least 10 characters")});function fe({onSubmit:t,isLoading:g}){const{user:a}=_(),[h,f]=n.useState("type"),[b,m]=n.useState([]),{register:x,handleSubmit:v,watch:j,setValue:C,formState:{errors:p},reset:S}=te({resolver:se(ye),mode:"onSubmit",defaultValues:{type:void 0,subject:"",description:""}}),r=j("type"),d=s=>{C("type",s),f("form")},R=s=>{const y=s.target.files;if(!y)return;const c=Array.from(y),E=[];for(const I of c){if(I.size>5*1024*1024){alert(`${I.name} exceeds 5MB limit`);continue}if(!["image/jpeg","image/png","application/pdf"].includes(I.type)){alert(`${I.name} is not a supported file type (JPEG, PNG, PDF only)`);continue}E.push(I)}const O=[...b,...E].slice(0,3);m(O),s.target.value=""},D=s=>{m(y=>y.filter((c,E)=>E!==s))},w=async s=>{await t(s,b),S(),m([]),f("type")};return h==="type"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"What type of ticket would you like to create?"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>d("SUGGESTION"),className:"p-4 border-2 border-gray-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-colors text-left",children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Suggestion"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Share an idea or feedback"})]}),e.jsxs("button",{type:"button",onClick:()=>d("COMPLAINT"),className:"p-4 border-2 border-gray-200 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition-colors text-left",children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Complaint"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Report an issue that needs resolution"})]})]})]}):e.jsxs("form",{onSubmit:v(w,()=>{}),className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("button",{type:"button",onClick:()=>{f("type"),S()},className:"text-sm text-blue-600 hover:text-blue-800",children:"← Change type"}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${r==="SUGGESTION"?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800"}`,children:r==="SUGGESTION"?"Suggestion":"Complaint"})]}),((a==null?void 0:a.role)==="HOST"||(a==null?void 0:a.role)==="STAFF")&&e.jsxs("div",{className:"px-3 py-2 bg-blue-50 border border-blue-100 rounded-md text-sm",children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Visitor system complaint"}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Your ticket will be automatically linked to your host/company"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Subject *"}),e.jsx("input",{...x("subject"),type:"text",className:`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${p.subject?"border-red-300":"border-gray-300"}`,placeholder:"Brief summary of your ticket"}),p.subject&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:p.subject.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description *"}),e.jsx("textarea",{...x("description"),rows:4,className:`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${p.description?"border-red-300":"border-gray-300"}`,placeholder:"Provide detailed information (at least 10 characters)..."}),p.description&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:p.description.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Attachments (",b.length,"/3)"]}),b.length<3&&e.jsx("input",{type:"file",onChange:R,accept:"image/jpeg,image/png,application/pdf",className:"block w-full text-sm text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"}),b.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:b.map((s,y)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 px-3 py-1.5 rounded text-sm",children:[e.jsxs("span",{className:"truncate",children:[s.name," (",(s.size/1024).toFixed(0)," KB)"]}),e.jsx("button",{type:"button",onClick:()=>D(y),className:"text-red-500 hover:text-red-700 ml-2",children:"×"})]},y))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Max 3 files, 5MB each. JPEG, PNG, or PDF."})]}),e.jsx("div",{className:"flex justify-end gap-3 pt-2",children:e.jsx("button",{type:"submit",disabled:g,className:"px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:g?"Submitting...":"Submit Ticket"})})]})}function je({isOpen:t,onClose:g,onSubmit:a,isLoading:h}){return n.useEffect(()=>(t?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[t]),t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 z-40",onClick:g}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-start justify-center overflow-y-auto p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-lg my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"New Ticket"}),e.jsx("button",{onClick:g,className:"text-gray-400 hover:text-gray-600 text-xl leading-none",children:"×"})]}),e.jsx("div",{className:"px-5 py-4",children:e.jsx(fe,{onSubmit:a,isLoading:h})})]})})]}):null}function Se(){const{user:t}=_(),{success:g,error:a}=le(),h=(t==null?void 0:t.role)==="ADMIN",[f,b]=n.useState([]),[m,x]=n.useState(null),[v,j]=n.useState(!1),[C,p]=n.useState(!1),[S,r]=n.useState(!1),[d,R]=n.useState("COMPLAINT"),[D,w]=n.useState("list"),[s,y]=n.useState({page:1,limit:10,total:0,totalPages:1}),[c,E]=n.useState(""),[O,I]=n.useState(""),[A,l]=n.useState(""),[N,M]=n.useState(""),T=n.useCallback(async(o=1,u="",i=d,k="",U="",$="")=>{j(!0);try{const P={page:o,limit:s.limit,type:i,sortBy:"createdAt",sortOrder:"desc"};u&&(P.search=u),k&&(P.status=k),U&&(P.dateFrom=U),$&&(P.dateTo=$);const L=await oe(P);b(L.data||[]),y({page:L.page||1,limit:L.limit||10,total:L.total||0,totalPages:L.totalPages||1})}catch(P){a((P==null?void 0:P.message)||"Failed to load tickets")}finally{j(!1)}},[d,s.limit,a]);n.useEffect(()=>{T(1,"",d)},[]);const F=o=>{R(o),E(""),I(""),l(""),M(""),T(1,"",o,"","","")},z=o=>{E(o),T(1,o,d,O,A,N)},H=o=>{I(o),T(1,c,d,o,A,N)},W=(o,u)=>{l(o),M(u),T(1,c,d,O,o,u)},K=o=>{T(o,c,d,O,A,N)},q=async o=>{try{const u=await G(o.id);x(u),w("detail")}catch{a("Failed to load ticket details")}},Q=async(o,u)=>{p(!0);try{const i=await de(o);for(const k of u)try{await ce(i.id,k)}catch{a(`Failed to upload ${k.name}`)}g(`Ticket ${i.ticketNumber} created successfully`),r(!1),T(1,c,d,O,A,N)}catch(i){a((i==null?void 0:i.message)||"Failed to create ticket")}finally{p(!1)}},X=async o=>{var u;if(m)try{const i=await ie(m.id,o);x(i),g("Ticket updated successfully")}catch(i){if((i==null?void 0:i.statusCode)===409||(u=i==null?void 0:i.message)!=null&&u.includes("modified")){a("This ticket was modified by another user. Please refresh.");const k=await G(m.id);x(k)}else a((i==null?void 0:i.message)||"Failed to update ticket")}},Y=async(o,u)=>{if(m)try{await me(m.id,{message:o,isInternal:u});const i=await G(m.id);x(i)}catch{a("Failed to add comment")}},Z=async o=>{if(m)try{const u=await xe(m.id,o);x(u),g("Ticket reopened successfully")}catch(u){a((u==null?void 0:u.message)||"Failed to reopen ticket")}},ee=()=>{w("list"),x(null),T(s.page,c,d,O,A,N)};return e.jsxs("div",{className:"p-6",children:[D==="list"&&e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Tickets"}),e.jsx("button",{onClick:()=>r(!0),className:"px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700",children:"New Ticket"})]}),D==="list"?e.jsx(ue,{tickets:f,isLoading:v,pagination:s,activeTab:d,onTabChange:F,onSearch:z,onStatusFilter:H,onPageChange:K,onTicketClick:q,onDateRangeFilter:W,dateFrom:A,dateTo:N}):m?e.jsx(be,{ticket:m,isAdmin:h,currentUserId:Number(t==null?void 0:t.id)||0,onUpdate:X,onAddComment:Y,onReopen:Z,onBack:ee}):null,e.jsx(je,{isOpen:S,onClose:()=>r(!1),onSubmit:Q,isLoading:C})]})}export{Se as default};
