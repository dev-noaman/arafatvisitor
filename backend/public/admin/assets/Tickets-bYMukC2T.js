import{r as o,j as e,a as q,c as de,t as ie,o as ce,s as K,_ as me,u as xe,g as ue}from"./index-DhWX03Cy.js";import{a as _,b as Q,d as pe,c as ge,e as J,f as he,u as be,h as ye,i as fe,r as je}from"./tickets-vxLJ4TPM.js";function Ne({tickets:t,isLoading:f,pagination:r,activeTab:u,onTabChange:j,onSearch:N,onStatusFilter:m,onPageChange:h,onTicketClick:v,adminUsers:b,onAssigneeFilter:E,onDateRangeFilter:y,dateFrom:w="",dateTo:n=""}){const[S,T]=o.useState(""),p=s=>{s.preventDefault(),N(S)},F=s=>new Date(s).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),i=["OPEN","IN_PROGRESS","RESOLVED","CLOSED","REJECTED"],C=["SUBMITTED","REVIEWED","DISMISSED"];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex border-b border-gray-200",children:[e.jsx("button",{onClick:()=>j("COMPLAINT"),className:`px-4 py-2 text-sm font-medium border-b-2 -mb-px transition-colors ${u==="COMPLAINT"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Complaints"}),e.jsx("button",{onClick:()=>j("SUGGESTION"),className:`px-4 py-2 text-sm font-medium border-b-2 -mb-px transition-colors ${u==="SUGGESTION"?"border-blue-600 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700"}`,children:"Suggestions"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("form",{onSubmit:p,className:"flex-1 min-w-[200px]",children:e.jsx("input",{type:"text",value:S,onChange:s=>T(s.target.value),placeholder:"Search by subject or ticket number...",className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",onKeyDown:s=>{s.key==="Enter"&&(s.preventDefault(),N(S))}})}),e.jsxs("select",{onChange:s=>m(s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Statuses"}),(u==="COMPLAINT"?i:C).map(s=>e.jsx("option",{value:s,children:_(s)},s))]}),u==="COMPLAINT"&&b&&b.length>0&&E&&e.jsx(e.Fragment,{children:e.jsxs("select",{onChange:s=>E(s.target.value?Number(s.target.value):""),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"All Assignees"}),b.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})}),y&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"date",value:w,onChange:s=>y(s.target.value,n),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",title:"From date"}),e.jsx("span",{className:"text-gray-400 text-sm",children:"to"}),e.jsx("input",{type:"date",value:n,onChange:s=>y(w,s.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",title:"To date"})]})]}),e.jsx("div",{className:"overflow-x-auto bg-white rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Ticket #"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Subject"}),u==="COMPLAINT"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Host"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Assigned To"})]}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Created By"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:f?e.jsx("tr",{children:e.jsx("td",{colSpan:u==="COMPLAINT"?7:5,className:"px-4 py-8 text-center text-sm text-gray-500",children:"Loading..."})}):t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:u==="COMPLAINT"?7:5,className:"px-4 py-8 text-center text-sm text-gray-500",children:"No tickets found."})}):t.map(s=>{var g;return e.jsxs("tr",{onClick:()=>v(s),className:"hover:bg-gray-50 cursor-pointer",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-mono text-gray-900",children:s.ticketNumber}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900 max-w-[200px] truncate",children:s.subject}),u==="COMPLAINT"&&e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.host?`${s.host.name} (${s.host.company})`:e.jsx("span",{className:"text-gray-400",children:"—"})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:((g=s.assignedTo)==null?void 0:g.name)||e.jsx("span",{className:"text-gray-400",children:"Unassigned"})})]}),e.jsxs("td",{className:"px-4 py-3 text-sm text-gray-600",children:[s.createdBy.name,e.jsx("span",{className:`ml-1.5 text-[10px] font-medium px-1 py-0.5 rounded ${s.createdBy.role==="ADMIN"?"bg-red-100 text-red-700":s.createdBy.role==="HOST"?"bg-green-100 text-green-700":s.createdBy.role==="RECEPTION"?"bg-blue-100 text-blue-700":"bg-purple-100 text-purple-700"}`,children:s.createdBy.role})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${Q(s.status)}`,children:_(s.status)})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-500",children:F(s.createdAt)})]},s.id)})})]})}),r.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsxs("p",{className:"text-sm text-gray-600",children:["Showing ",(r.page-1)*r.limit+1," to"," ",Math.min(r.page*r.limit,r.total)," of ",r.total]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>h(r.page-1),disabled:r.page<=1,className:"px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Previous"}),Array.from({length:Math.min(5,r.totalPages)},(s,g)=>{let x;return r.totalPages<=5||r.page<=3?x=g+1:r.page>=r.totalPages-2?x=r.totalPages-4+g:x=r.page-2+g,e.jsx("button",{onClick:()=>h(x),className:`px-3 py-1.5 text-sm border rounded-md ${x===r.page?"bg-blue-600 text-white border-blue-600":"border-gray-300 hover:bg-gray-50"}`,children:x},x)}),e.jsx("button",{onClick:()=>h(r.page+1),disabled:r.page>=r.totalPages,className:"px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Next"})]})]})]})}function ve({comments:t,onAddComment:f,isAdmin:r,isLoading:u}){const[j,N]=o.useState(""),[m,h]=o.useState(!1),[v,b]=o.useState(!1),E=async n=>{if(n.preventDefault(),!!j.trim()){b(!0);try{await f(j.trim(),r?m:!1),N(""),h(!1)}finally{b(!1)}}},y=n=>new Date(n).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}),w=n=>{if(!n)return null;const S={ADMIN:"bg-red-100 text-red-700",RECEPTION:"bg-blue-100 text-blue-700",HOST:"bg-green-100 text-green-700",STAFF:"bg-purple-100 text-purple-700"};return e.jsx("span",{className:`text-[10px] font-medium px-1.5 py-0.5 rounded ${S[n]||"bg-gray-100 text-gray-700"}`,children:n})};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900",children:["Comments (",t.length,")"]}),t.length===0?e.jsx("p",{className:"text-sm text-gray-500 italic",children:"No comments yet."}):e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:t.map(n=>e.jsxs("div",{className:`p-3 rounded-lg text-sm ${n.isInternal?"bg-amber-50 border border-amber-200":"bg-gray-50 border border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:n.user.name}),w(n.user.role),n.isInternal&&e.jsx("span",{className:"text-[10px] font-medium px-1.5 py-0.5 rounded bg-amber-100 text-amber-700",children:"Internal Note"}),e.jsx("span",{className:"text-xs text-gray-500 ml-auto",children:y(n.createdAt)})]}),e.jsx("p",{className:"text-gray-700 whitespace-pre-wrap",children:n.message})]},n.id))}),!u&&e.jsxs("form",{onSubmit:E,className:"space-y-2",children:[e.jsx("textarea",{value:j,onChange:n=>N(n.target.value),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Write a comment..."}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{children:r&&e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx("input",{type:"checkbox",checked:m,onChange:n=>h(n.target.checked),className:"rounded border-gray-300"}),"Internal note (hidden from ticket creator)"]})}),e.jsx("button",{type:"submit",disabled:!j.trim()||v,className:"px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:v?"Sending...":"Send"})]})]})]})}const Se={OPEN:["IN_PROGRESS","REJECTED"],IN_PROGRESS:["RESOLVED","REJECTED"],RESOLVED:["CLOSED"]},we={SUBMITTED:["REVIEWED","DISMISSED"]};function Ce({ticket:t,isAdmin:f,currentUserId:r,adminUsers:u,onUpdate:j,onAddComment:N,onReopen:m,onBack:h}){var M,A,U;const[v,b]=o.useState(!1),[E,y]=o.useState(""),[w,n]=o.useState(""),[S,T]=o.useState(!1),[p,F]=o.useState(""),i=t.type==="COMPLAINT",s=t.createdBy.id===r&&i&&t.status==="RESOLVED",g=i?Se[t.status]||[]:we[t.status]||[],x=a=>a?new Date(a).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}):"—",D=async a=>{if(a==="RESOLVED"&&!E.trim()){alert("Resolution text is required");return}if(a==="REJECTED"&&!w.trim()){alert("Rejection reason is required");return}b(!0);try{const I={status:a,updatedAt:t.updatedAt};a==="RESOLVED"&&(I.resolution=E),a==="REJECTED"&&(I.rejectionReason=w),await j(I),y(""),n("")}finally{b(!1)}},P=async a=>{b(!0);try{await j({assignedToId:a,updatedAt:t.updatedAt})}finally{b(!1)}},$=async()=>{if(p.trim()){b(!0);try{await m(p),F(""),T(!1)}finally{b(!1)}}},L=async(a,I)=>{try{const R=await pe(t.id,a),V=URL.createObjectURL(R),B=document.createElement("a");B.href=V,B.download=I,B.click(),URL.revokeObjectURL(V)}catch{alert("Failed to download attachment")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-start justify-between",children:e.jsxs("div",{children:[e.jsx("button",{onClick:h,className:"text-sm text-blue-600 hover:text-blue-800 mb-2",children:"← Back to list"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:t.ticketNumber}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${i?"bg-orange-100 text-orange-800":"bg-purple-100 text-purple-800"}`,children:i?"Complaint":"Suggestion"}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${Q(t.status)}`,children:_(t.status)}),i&&t.host&&e.jsxs("span",{className:"text-xs text-gray-600",children:[t.host.name," (",t.host.company,")"]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-2",children:t.subject}),e.jsx("p",{className:"text-sm text-gray-700 whitespace-pre-wrap",children:t.description})]}),t.resolution&&e.jsxs("div",{className:"bg-green-50 rounded-lg border border-green-200 p-5",children:[e.jsx("h4",{className:"text-sm font-semibold text-green-800 mb-1",children:"Resolution"}),e.jsx("p",{className:"text-sm text-green-700 whitespace-pre-wrap",children:t.resolution}),t.resolvedAt&&e.jsxs("p",{className:"text-xs text-green-600 mt-2",children:["Resolved by ",((M=t.assignedTo)==null?void 0:M.name)||"Admin"," on ",x(t.resolvedAt)]})]}),t.rejectionReason&&e.jsxs("div",{className:"bg-red-50 rounded-lg border border-red-200 p-5",children:[e.jsx("h4",{className:"text-sm font-semibold text-red-800 mb-1",children:"Rejection Reason"}),e.jsx("p",{className:"text-sm text-red-700 whitespace-pre-wrap",children:t.rejectionReason})]}),t.attachments&&t.attachments.length>0&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:[e.jsxs("h4",{className:"text-sm font-semibold text-gray-900 mb-3",children:["Attachments (",t.attachments.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:t.attachments.map(a=>e.jsxs("div",{onClick:()=>L(a.id,a.fileName),className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-100",children:[e.jsx("div",{className:"w-8 h-8 flex items-center justify-center bg-blue-100 rounded text-blue-600 text-xs font-bold",children:a.mimeType.includes("pdf")?"PDF":"IMG"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:a.fileName}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(a.fileSize/1024).toFixed(0)," KB"]})]})]},a.id))})]}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-5",children:e.jsx(ve,{comments:t.comments||[],onAddComment:N,isAdmin:f})}),s&&!S&&e.jsx("button",{onClick:()=>T(!0),className:"px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700",children:"Reopen Ticket"}),S&&e.jsxs("div",{className:"bg-yellow-50 rounded-lg border border-yellow-200 p-5 space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-yellow-800",children:"Reopen this complaint"}),e.jsx("textarea",{value:p,onChange:a=>F(a.target.value),rows:3,className:"w-full px-3 py-2 border border-yellow-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500",placeholder:"Explain why you want to reopen this ticket..."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:$,disabled:!p.trim()||v,className:"px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-md hover:bg-yellow-700 disabled:opacity-50",children:v?"Reopening...":"Confirm Reopen"}),e.jsx("button",{onClick:()=>{T(!1),F("")},className:"px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-md hover:bg-gray-300",children:"Cancel"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Created By"}),e.jsx("p",{className:"text-sm text-gray-900",children:t.createdBy.name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.createdBy.role})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Created"}),e.jsx("p",{className:"text-sm text-gray-900",children:x(t.createdAt)})]}),i&&e.jsxs(e.Fragment,{children:[t.host&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Host / Company"}),e.jsxs("p",{className:"text-sm text-gray-900",children:[t.host.name," (",t.host.company,")"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Assigned To"}),e.jsx("p",{className:"text-sm text-gray-900",children:((A=t.assignedTo)==null?void 0:A.name)||"Unassigned"})]})]}),t.closedAt&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-medium",children:"Closed"}),e.jsx("p",{className:"text-sm text-gray-900",children:x(t.closedAt)})]})]}),f&&g.length>0&&e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4 space-y-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Admin Actions"}),i&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Assign To"}),e.jsxs("select",{value:((U=t.assignedTo)==null?void 0:U.id)||"",onChange:a=>P(a.target.value?Number(a.target.value):null),disabled:v,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",children:[e.jsx("option",{value:"",children:"Unassigned"}),u.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),g.includes("RESOLVED")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Resolution *"}),e.jsx("textarea",{value:E,onChange:a=>y(a.target.value),rows:3,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",placeholder:"Describe how this was resolved..."})]}),g.includes("REJECTED")&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 uppercase font-medium mb-1",children:"Rejection Reason"}),e.jsx("textarea",{value:w,onChange:a=>n(a.target.value),rows:2,className:"w-full px-2 py-1.5 border border-gray-300 rounded text-sm",placeholder:"Reason for rejection..."})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map(a=>{const I={IN_PROGRESS:"bg-indigo-600 hover:bg-indigo-700",RESOLVED:"bg-green-600 hover:bg-green-700",CLOSED:"bg-gray-600 hover:bg-gray-700",REJECTED:"bg-red-600 hover:bg-red-700",REVIEWED:"bg-green-600 hover:bg-green-700",DISMISSED:"bg-gray-600 hover:bg-gray-700"};return e.jsx("button",{onClick:()=>D(a),disabled:v,className:`px-3 py-1.5 text-white text-sm font-medium rounded-md disabled:opacity-50 ${I[a]||"bg-blue-600 hover:bg-blue-700"}`,children:v?"...":_(a)},a)})})]})]})]})]})}const Ee=ce({type:me(["SUGGESTION","COMPLAINT"]),subject:K().min(3,"Subject must be at least 3 characters").max(200,"Subject cannot exceed 200 characters"),description:K().min(10,"Description must be at least 10 characters")});function Te({onSubmit:t,isLoading:f}){const{user:r}=q(),[u,j]=o.useState("type"),[N,m]=o.useState([]),{register:h,handleSubmit:v,watch:b,setValue:E,formState:{errors:y},reset:w}=de({resolver:ie(Ee),defaultValues:{type:void 0,subject:"",description:""}}),n=b("type"),S=i=>{E("type",i),j("form")},T=i=>{const C=i.target.files;if(!C)return;const s=Array.from(C),g=[];for(const D of s){if(D.size>5*1024*1024){alert(`${D.name} exceeds 5MB limit`);continue}if(!["image/jpeg","image/png","application/pdf"].includes(D.type)){alert(`${D.name} is not a supported file type (JPEG, PNG, PDF only)`);continue}g.push(D)}const x=[...N,...g].slice(0,3);m(x),i.target.value=""},p=i=>{m(C=>C.filter((s,g)=>g!==i))},F=async i=>{await t(i,N),w(),m([]),j("type")};return u==="type"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"What type of ticket would you like to create?"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>S("SUGGESTION"),className:"p-4 border-2 border-gray-200 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition-colors text-left",children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Suggestion"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Share an idea or feedback"})]}),e.jsxs("button",{type:"button",onClick:()=>S("COMPLAINT"),className:"p-4 border-2 border-gray-200 rounded-lg hover:border-orange-400 hover:bg-orange-50 transition-colors text-left",children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Complaint"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Report an issue that needs resolution"})]})]})]}):e.jsxs("form",{onSubmit:v(F),className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("button",{type:"button",onClick:()=>{j("type"),w()},className:"text-sm text-blue-600 hover:text-blue-800",children:"← Change type"}),e.jsx("span",{className:`text-xs font-medium px-2 py-0.5 rounded ${n==="SUGGESTION"?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800"}`,children:n==="SUGGESTION"?"Suggestion":"Complaint"})]}),((r==null?void 0:r.role)==="HOST"||(r==null?void 0:r.role)==="STAFF")&&e.jsxs("div",{className:"px-3 py-2 bg-blue-50 border border-blue-100 rounded-md text-sm",children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Visitor system complaint"}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Your ticket will be automatically linked to your host/company"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Subject *"}),e.jsx("input",{...h("subject"),type:"text",className:`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${y.subject?"border-red-300":"border-gray-300"}`,placeholder:"Brief summary of your ticket"}),y.subject&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:y.subject.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description *"}),e.jsx("textarea",{...h("description"),rows:4,className:`w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${y.description?"border-red-300":"border-gray-300"}`,placeholder:"Provide detailed information..."}),y.description&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:y.description.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Attachments (",N.length,"/3)"]}),N.length<3&&e.jsx("input",{type:"file",onChange:T,accept:"image/jpeg,image/png,application/pdf",className:"block w-full text-sm text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"}),N.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:N.map((i,C)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 px-3 py-1.5 rounded text-sm",children:[e.jsxs("span",{className:"truncate",children:[i.name," (",(i.size/1024).toFixed(0)," KB)"]}),e.jsx("button",{type:"button",onClick:()=>p(C),className:"text-red-500 hover:text-red-700 ml-2",children:"×"})]},C))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Max 3 files, 5MB each. JPEG, PNG, or PDF."})]}),e.jsx("div",{className:"flex justify-end gap-3 pt-2",children:e.jsx("button",{type:"submit",disabled:f,className:"px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:f?"Submitting...":"Submit Ticket"})})]})}function Re({isOpen:t,onClose:f,onSubmit:r,isLoading:u}){return o.useEffect(()=>(t?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[t]),t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/40 z-40",onClick:f}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-start justify-center overflow-y-auto p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-lg my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"New Ticket"}),e.jsx("button",{onClick:f,className:"text-gray-400 hover:text-gray-600 text-xl leading-none",children:"×"})]}),e.jsx("div",{className:"px-5 py-4",children:e.jsx(Te,{onSubmit:r,isLoading:u})})]})})]}):null}function Ie(){const{user:t}=q(),{success:f,error:r}=xe(),u=(t==null?void 0:t.role)==="ADMIN",[j,N]=o.useState([]),[m,h]=o.useState(null),[v,b]=o.useState([]),[E,y]=o.useState(!1),[w,n]=o.useState(!1),[S,T]=o.useState(!1),[p,F]=o.useState("COMPLAINT"),[i,C]=o.useState("list"),[s,g]=o.useState({page:1,limit:10,total:0,totalPages:1}),[x,D]=o.useState(""),[P,$]=o.useState(""),[L,M]=o.useState(""),[A,U]=o.useState(""),[a,I]=o.useState(""),R=o.useCallback(async(l=1,d="",c=p,k="",z="",H="",W="")=>{y(!0);try{const O={page:l,limit:s.limit,type:c,sortBy:"createdAt",sortOrder:"desc"};d&&(O.search=d),k&&(O.status=k),z&&(O.assignedToId=z),H&&(O.dateFrom=H),W&&(O.dateTo=W);const G=await ge(O);N(G.data||[]),g({page:G.page||1,limit:G.limit||10,total:G.total||0,totalPages:G.totalPages||1})}catch(O){r((O==null?void 0:O.message)||"Failed to load tickets")}finally{y(!1)}},[p,s.limit,r]),V=o.useCallback(async()=>{if(u)try{const l=await ue("/admin/api/users?role=ADMIN&limit=100");Array.isArray(l)?b(l.map(d=>({id:Number(d.id),name:d.name||d.email}))):l!=null&&l.data&&b(l.data.map(d=>({id:Number(d.id),name:d.name||d.email})))}catch{}},[u]);o.useEffect(()=>{R(1,"",p),V()},[]);const B=l=>{F(l),D(""),$(""),M(""),U(""),I(""),R(1,"",l,"","","","")},X=l=>{D(l),R(1,l,p,P,L,A,a)},Y=l=>{$(l),R(1,x,p,l,L,A,a)},Z=l=>{M(l),R(1,x,p,P,l,A,a)},ee=(l,d)=>{U(l),I(d),R(1,x,p,P,L,l,d)},te=l=>{R(l,x,p,P,L,A,a)},se=async l=>{try{const d=await J(l.id);h(d),C("detail")}catch{r("Failed to load ticket details")}},ae=async(l,d)=>{n(!0);try{const c=await he(l);for(const k of d)try{await be(c.id,k)}catch{r(`Failed to upload ${k.name}`)}f(`Ticket ${c.ticketNumber} created successfully`),T(!1),R(1,x,p,P,L,A,a)}catch(c){r((c==null?void 0:c.message)||"Failed to create ticket")}finally{n(!1)}},re=async l=>{var d;if(m)try{const c=await ye(m.id,l);h(c),f("Ticket updated successfully")}catch(c){if((c==null?void 0:c.statusCode)===409||(d=c==null?void 0:c.message)!=null&&d.includes("modified")){r("This ticket was modified by another user. Please refresh.");const k=await J(m.id);h(k)}else r((c==null?void 0:c.message)||"Failed to update ticket")}},le=async(l,d)=>{if(m)try{await fe(m.id,{message:l,isInternal:d});const c=await J(m.id);h(c)}catch{r("Failed to add comment")}},ne=async l=>{if(m)try{const d=await je(m.id,l);h(d),f("Ticket reopened successfully")}catch(d){r((d==null?void 0:d.message)||"Failed to reopen ticket")}},oe=()=>{C("list"),h(null),R(s.page,x,p,P,L,A,a)};return e.jsxs("div",{className:"p-6",children:[i==="list"&&e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Tickets"}),e.jsx("button",{onClick:()=>T(!0),className:"px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700",children:"New Ticket"})]}),i==="list"?e.jsx(Ne,{tickets:j,isLoading:E,pagination:s,activeTab:p,onTabChange:B,onSearch:X,onStatusFilter:Y,onPageChange:te,onTicketClick:se,adminUsers:v,onAssigneeFilter:Z,onDateRangeFilter:ee,dateFrom:A,dateTo:a}):m?e.jsx(Ce,{ticket:m,isAdmin:u,currentUserId:Number(t==null?void 0:t.id)||0,adminUsers:v,onUpdate:re,onAddComment:le,onReopen:ne,onBack:oe}):null,e.jsx(Re,{isOpen:S,onClose:()=>T(!1),onSubmit:ae,isLoading:w})]})}export{Ie as default};
