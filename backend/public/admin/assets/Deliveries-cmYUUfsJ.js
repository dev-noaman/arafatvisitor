import{r as n,j as e,c as X,t as Z,o as ee,s as R,b as M,a as B,u as te}from"./index-DhWX03Cy.js";import{a as se,b as re}from"./lookups-B1z8U9ad.js";import{g as le}from"./hosts-r3Q6BTCa.js";import{S as O}from"./SearchableSelect-ClOu6u_R.js";import{E as oe}from"./ErrorState-CQnIf7eq.js";function ae({hosts:t,value:s,onChange:a,disabled:h,isLoading:y,error:w}){const[g,b]=n.useState(""),[x,i]=n.useState(!1),k=n.useRef(null);n.useEffect(()=>{if(s){const o=t.find(v=>String(v.id)===String(s));o&&b(o.company)}else b("")},[s,t]),n.useEffect(()=>{function o(v){k.current&&!k.current.contains(v.target)&&i(!1)}return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[]);const u=t.some(o=>o.company===g&&String(o.id)===String(s)),f=g&&!u?t.filter(o=>o.company.toLowerCase().includes(g.toLowerCase())||o.name.toLowerCase().includes(g.toLowerCase())):t,p=o=>{a(String(o.id)),b(o.company),i(!1)},N=o=>{b(o.target.value),i(!0),o.target.value||a("")};return e.jsxs("div",{ref:k,className:"relative",children:[e.jsx("input",{type:"text",value:g,onChange:N,onFocus:()=>i(!0),placeholder:y?"Loading hosts...":"Search by company or host name...",disabled:h||y,className:`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${w?"border-red-300":"border-gray-300"}`}),e.jsx("div",{className:"absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),x&&f.length>0&&e.jsxs("ul",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto",children:[f.slice(0,50).map(o=>e.jsxs("li",{onClick:()=>p(o),className:`px-3 py-2 cursor-pointer hover:bg-blue-50 text-sm ${String(o.id)===String(s)?"bg-blue-50 font-medium":""}`,children:[e.jsx("span",{children:o.company}),o.name!==o.company&&e.jsxs("span",{className:"text-gray-400 ml-1",children:["— ",o.name]})]},o.id)),f.length>50&&e.jsxs("li",{className:"px-3 py-2 text-xs text-gray-400 text-center",children:["Type to narrow down ",f.length," results..."]})]}),x&&g&&f.length===0&&e.jsxs("div",{className:"absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg px-3 py-3 text-sm text-gray-500 text-center",children:['No company found matching "',g,'"']})]})}const ne=ee({deliveryType:R().min(1,"Please select delivery type"),hostId:R().min(1,"Please select a host"),courier:R().min(1,"Please select a courier")});function ie({onSubmit:t,isLoading:s}){var E,l,m;const[a,h]=n.useState([]),[y,w]=n.useState([]),[g,b]=n.useState([]),[x,i]=n.useState(!0);n.useEffect(()=>{Promise.all([se(),re(),le({page:1,limit:1e3})]).then(([r,d,j])=>{h(r),w(d),b(j.data||[])}).catch(()=>{h([]),w([]),b([])}).finally(()=>i(!1))},[]);const{handleSubmit:k,formState:{errors:u},reset:f,watch:p,setValue:N}=X({resolver:Z(ne),defaultValues:{deliveryType:"",hostId:"",courier:""}}),o=p("deliveryType"),v=n.useMemo(()=>y.filter(r=>o==="Food"||o==="Gift"?r.category==="FOOD":r.category==="PARCEL"||!r.category),[y,o]),D=a.map(r=>({value:r.label,label:r.label})),P=v.map(r=>({value:r.label,label:r.label}));n.useEffect(()=>{const r=p("courier"),d=v.some(j=>j.label===r);r&&!d&&N("courier","")},[o]);const C=async r=>{await t(r),f()};return e.jsxs("form",{onSubmit:k(C),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deliveryType",className:"block text-sm font-medium text-gray-700 mb-1",children:"Type of Delivery *"}),e.jsx(O,{options:D,value:p("deliveryType")||"",onChange:r=>N("deliveryType",r,{shouldValidate:!0}),placeholder:x?"Loading...":"Type to search delivery type...",disabled:s||x,isLoading:x,error:(E=u.deliveryType)==null?void 0:E.message,emptyMessage:"No delivery type found"}),u.deliveryType&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.deliveryType.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Host *"}),e.jsx(ae,{hosts:g,value:p("hostId")||"",onChange:r=>N("hostId",r,{shouldValidate:!0}),disabled:s,isLoading:x,error:(l=u.hostId)==null?void 0:l.message}),u.hostId&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.hostId.message})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"courier",className:"block text-sm font-medium text-gray-700 mb-1",children:"Courier *"}),e.jsx(O,{options:P,value:p("courier")||"",onChange:r=>N("courier",r,{shouldValidate:!0}),placeholder:x?"Loading...":o?"Type to search courier...":"Select delivery type first",disabled:s||x||!o,error:(m=u.courier)==null?void 0:m.message,emptyMessage:"No courier found"}),u.courier&&e.jsx("p",{className:"text-sm text-red-600 mt-1",children:u.courier.message})]}),e.jsx("button",{type:"submit",disabled:s||x,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 transition",children:s?"Saving...":"Record Delivery"})]})}const de=async t=>{const s=new URLSearchParams;t!=null&&t.page&&s.append("page",t.page.toString()),t!=null&&t.limit&&s.append("limit",t.limit.toString()),t!=null&&t.search&&s.append("search",t.search),t!=null&&t.status&&s.append("status",t.status),t!=null&&t.sortBy&&s.append("sortBy",t.sortBy),t!=null&&t.sortOrder&&s.append("sortOrder",t.sortOrder);const a=s.toString(),h=`/admin/api/deliveries${a?`?${a}`:""}`;return await M.get(h)},ce=async t=>await M.post("/admin/api/deliveries",t),ue=async(t,s)=>await M.put(`/admin/api/deliveries/${t}`,s),xe=async t=>await M.delete(`/admin/api/deliveries/${t}`),me=async t=>await M.post(`/admin/api/deliveries/${t}/mark-picked-up`,{}),$=t=>({RECEIVED:"bg-yellow-100 text-yellow-800",PENDING:"bg-yellow-100 text-yellow-800",PICKED_UP:"bg-green-100 text-green-800"})[t]||"bg-gray-100 text-gray-800",V=t=>({RECEIVED:"Awaiting Pickup",PENDING:"Awaiting Pickup",PICKED_UP:"Picked Up"})[t]||t,he=["RECEIVED","PICKED_UP"];function ye({deliveries:t,isLoading:s,pagination:a,onSearch:h,onStatusFilter:y,onPageChange:w,onEdit:g,onDelete:b,onMarkPickedUp:x}){const{user:i}=B(),k=(i==null?void 0:i.role)==="ADMIN",u=(i==null?void 0:i.role)==="ADMIN"||(i==null?void 0:i.role)==="RECEPTION",[f,p]=n.useState(""),[N,o]=n.useState(""),v=l=>{const m=l.target.value;p(m),h(m)},D=l=>{o(l),y(l)},P=()=>{a.page>1&&w(a.page-1)},C=()=>{a.page<a.totalPages&&w(a.page+1)},E=l=>l.status==="RECEIVED"||l.status==="PENDING";return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200 space-y-4",children:[e.jsx("div",{children:e.jsx("input",{type:"text",placeholder:"Search by recipient, company, or description...",value:f,onChange:v,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Filter by Status"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>D(""),className:`px-3 py-1 rounded-full text-sm font-medium transition ${N===""?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"All"}),he.map(l=>e.jsx("button",{onClick:()=>D(l),className:`px-3 py-1 rounded-full text-sm font-medium transition ${N===l?"bg-blue-600 text-white":`${$(l)} hover:opacity-80`}`,children:V(l)},l))]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Recipient"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Host Company"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Courier"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Received Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold text-gray-700",children:"Actions"})]})}),e.jsx("tbody",{children:s?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})})})}):t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-8 text-center text-gray-500",children:"No deliveries found."})}):t.map(l=>{var m,r;return e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50 transition",children:[e.jsxs("td",{className:"px-6 py-4 text-sm",children:[e.jsx("div",{className:"text-gray-900 font-medium",children:l.recipient||"—"}),e.jsx("div",{className:"text-xs text-gray-500",children:((m=l.host)==null?void 0:m.name)||"—"})]}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:((r=l.host)==null?void 0:r.company)||"—"}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:l.courier||"—"}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:l.receivedAt?new Date(l.receivedAt).toLocaleDateString():"—"}),e.jsx("td",{className:"px-6 py-4 text-sm",children:e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${$(l.status)}`,children:V(l.status)})}),e.jsxs("td",{className:"px-6 py-4 text-sm space-x-1",children:[E(l)&&x&&e.jsx("button",{onClick:()=>x(l),className:"inline-flex items-center p-2 rounded-lg text-green-600 hover:bg-green-50 transition",title:"Mark Picked Up",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})})}),u&&e.jsx("button",{onClick:()=>g(l),className:"inline-flex items-center p-2 rounded-lg text-blue-600 hover:bg-blue-50 transition",title:"Edit",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),k&&e.jsx("button",{onClick:()=>b(l),className:"inline-flex items-center p-2 rounded-lg text-red-600 hover:bg-red-50 transition",title:"Delete",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})]},l.id)})})]})}),!s&&t.length>0&&e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-gray-600",children:["Showing ",(a.page-1)*a.limit+1," to"," ",Math.min(a.page*a.limit,a.total)," of"," ",a.total," deliveries"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:P,disabled:a.page===1,className:"px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:text-gray-400 disabled:cursor-not-allowed transition",children:"Previous"}),e.jsx("div",{className:"flex items-center gap-1",children:(()=>{const l=a.page,m=a.totalPages,r=[];if(m<=7)for(let d=1;d<=m;d++)r.push(d);else{r.push(1),l>3&&r.push("...");for(let d=Math.max(2,l-1);d<=Math.min(m-1,l+1);d++)r.push(d);l<m-2&&r.push("..."),r.push(m)}return r.map((d,j)=>d==="..."?e.jsx("span",{className:"px-2 py-1 text-sm text-gray-500",children:"..."},`dots-${j}`):e.jsx("button",{onClick:()=>w(d),className:`px-3 py-1 rounded-lg text-sm font-medium transition ${d===l?"bg-blue-600 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:d},d))})()}),e.jsx("button",{onClick:C,disabled:a.page===a.totalPages,className:"px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:text-gray-400 disabled:cursor-not-allowed transition",children:"Next"})]})]})]})}function ge({isOpen:t,onClose:s,onSubmit:a,isLoading:h}){return n.useEffect(()=>(t?document.body.style.overflow="hidden":document.body.style.overflow="auto",()=>{document.body.style.overflow="auto"}),[t]),t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40",onClick:s}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4 overflow-y-auto",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg max-w-md w-full my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Record New Delivery"}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-gray-700","aria-label":"Close",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"px-6 py-4",children:e.jsx(ie,{onSubmit:a,isLoading:h})})]})})]}):null}function pe({isOpen:t,delivery:s,onConfirm:a,onCancel:h,isLoading:y}){return n.useEffect(()=>(t?document.body.style.overflow="hidden":document.body.style.overflow="auto",()=>{document.body.style.overflow="auto"}),[t]),!t||!s?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40",onClick:h}),e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg max-w-sm w-full",children:[e.jsx("div",{className:"flex justify-center py-6",children:e.jsx("div",{className:"flex items-center justify-center w-12 h-12 rounded-full bg-red-100",children:e.jsx("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})}),e.jsxs("div",{className:"text-center px-6 pb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Delete Delivery Record"}),e.jsxs("p",{className:"text-gray-600 mb-2",children:["Are you sure you want to delete the delivery record for"," ",e.jsx("span",{className:"font-medium",children:s.recipientName}),"?"]}),e.jsx("p",{className:"text-sm text-gray-500",children:"This action cannot be undone."})]}),e.jsxs("div",{className:"flex gap-2 px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-lg",children:[e.jsx("button",{onClick:h,disabled:y,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-white disabled:bg-gray-100 transition",children:"Cancel"}),e.jsx("button",{onClick:a,disabled:y,className:"flex-1 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 disabled:bg-gray-400 transition",children:y?"Deleting...":"Delete"})]})]})})]})}function we(){const{success:t,error:s}=te(),{user:a}=B(),h=(a==null?void 0:a.role)==="ADMIN"||(a==null?void 0:a.role)==="RECEPTION",[y,w]=n.useState([]),[g,b]=n.useState(!1),[x,i]=n.useState(null),[k,u]=n.useState(!1),[f,p]=n.useState(),[N,o]=n.useState(!1),[v,D]=n.useState(),[P,C]=n.useState(!1),[E,l]=n.useState(!1),[,m]=n.useState(!1),[r,d]=n.useState({page:1,limit:10,total:0,totalPages:1}),[j,H]=n.useState(""),[L,U]=n.useState(""),S=n.useCallback(async(c=1,T="",A="")=>{b(!0),i(null);try{const F={page:c,limit:r.limit};T&&(F.search=T),A&&(F.status=A);const I=await de(F);w(I.data||[]),d({page:I.page||1,limit:I.limit||10,total:I.total||0,totalPages:I.totalPages||1})}catch{i("Failed to load deliveries. Please check your connection and try again."),s("Failed to load deliveries")}finally{b(!1)}},[r.limit,s]);n.useEffect(()=>{S(1,"","")},[S]);const z=c=>{H(c),S(1,c,L)},W=c=>{U(c),S(1,j,c)},Q=c=>{S(c,j,L)},G=async c=>{l(!0);try{f?(await ue(f.id,c),t("Delivery updated successfully")):(await ce(c),t("Delivery recorded successfully")),u(!1),p(void 0),await S(r.page,j,L)}catch{s(f?"Failed to update delivery":"Failed to record delivery")}finally{l(!1)}},_=async c=>{m(!0);try{await me(c.id),t("Delivery marked as picked up"),await S(r.page,j,L)}catch{s("Failed to mark delivery as picked up")}finally{m(!1)}},q=async()=>{if(v){C(!0);try{await xe(v.id),t("Delivery deleted successfully"),o(!1),D(void 0),await S(r.page,j,L)}catch{s("Failed to delete delivery")}finally{C(!1)}}},K=c=>{p(c),u(!0)},Y=c=>{D(c),o(!0)},J=()=>{u(!1),p(void 0)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Deliveries Management"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Track and manage package deliveries"})]}),h&&e.jsx("button",{onClick:()=>{p(void 0),u(!0)},className:"px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition",children:e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Record Delivery"]})})]}),x&&!g&&e.jsx(oe,{title:"Failed to load deliveries",message:x,onRetry:()=>S(r.page,j,L)}),!x&&e.jsx(ye,{deliveries:y,isLoading:g,pagination:r,onSearch:z,onStatusFilter:W,onPageChange:Q,onEdit:K,onDelete:Y,onMarkPickedUp:_}),e.jsx(ge,{isOpen:k,onClose:J,onSubmit:G,isLoading:E}),e.jsx(pe,{isOpen:N,delivery:v,onConfirm:q,onCancel:()=>{o(!1),D(void 0)},isLoading:P})]})}export{we as default};
