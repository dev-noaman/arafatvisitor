name: Deploy to VPS

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      init:
        description: 'Run initial setup (first deployment)'
        required: false
        default: false
        type: boolean

env:
  VPS_PATH: /var/www/arafatvisitor
  DB_NAME: arafatvisitor
  DB_USER: arafatvisitor
  SSH_OPTS: '-o StrictHostKeyChecking=no -o ControlMaster=auto -o ControlPath=/tmp/ssh-%r@%h:%p -o ControlPersist=60s'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build frontend
        run: |
          npm ci
          npm run build
        env:
          VITE_API_BASE: https://${{ secrets.VPS_DOMAIN }}
          VITE_SHOW_DEBUG_LOGIN: "false"

      - name: Build admin
        run: |
          cd admin
          npm ci
          npm run build

      - name: Install sshpass and rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: Start SSH control master
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} -N -f ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }}

      - name: Prepare VPS directories
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "mkdir -p ${{ env.VPS_PATH }}/frontend ${{ env.VPS_PATH }}/backend"

      - name: Upload frontend
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' rsync -avz --delete -e "sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }}" dist/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }}:${{ env.VPS_PATH }}/frontend/

      - name: Upload backend
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' rsync -avz --delete --exclude 'node_modules' --exclude '.env' --exclude 'dist' -e "sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }}" backend/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }}:${{ env.VPS_PATH }}/backend/

      - name: Initial Setup
        if: github.event.inputs.init == 'true'
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} << 'ENDSSH'
          set -e

          # Install Node.js if not present
          if ! command -v node &> /dev/null; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
          fi

          # Install PostgreSQL if not present
          if ! command -v psql &> /dev/null; then
              apt-get install -y postgresql postgresql-contrib
              systemctl start postgresql
              systemctl enable postgresql
          fi

          # Install Nginx if not present
          if ! command -v nginx &> /dev/null; then
              apt-get install -y nginx
              systemctl start nginx
              systemctl enable nginx
          fi

          npm install -g pm2

          # Create database if not exists
          if ! sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw ${{ env.DB_NAME }}; then
              sudo -u postgres psql -c "CREATE USER ${{ env.DB_USER }} WITH PASSWORD '${{ secrets.DB_PASSWORD }}';" 2>/dev/null || true
              sudo -u postgres psql -c "CREATE DATABASE ${{ env.DB_NAME }} OWNER ${{ env.DB_USER }};"
              sudo -u postgres psql -d ${{ env.DB_NAME }} -c "GRANT ALL ON SCHEMA public TO ${{ env.DB_USER }};"
          fi

          cd /var/www/arafatvisitor/backend

          # Create .env
          cat > .env << EOF
          DATABASE_URL=postgresql://${{ env.DB_USER }}:${{ secrets.DB_PASSWORD }}@localhost:5432/${{ env.DB_NAME }}
          JWT_SECRET=$(openssl rand -base64 32)
          NODE_ENV=production
          PORT=3000
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASS=${{ secrets.SMTP_PASS }}
          SMTP_FROM=${{ secrets.SMTP_FROM }}
          WHATSAPP_ENDPOINT=${{ secrets.WHATSAPP_ENDPOINT }}
          WHATSAPP_CLIENT_ID=${{ secrets.WHATSAPP_CLIENT_ID }}
          WHATSAPP_CLIENT=${{ secrets.WHATSAPP_CLIENT }}
          WHATSAPP_API_KEY=${{ secrets.WHATSAPP_API_KEY }}
          EOF

          npm install --include=dev
          npx prisma generate
          npx prisma db push --accept-data-loss

          # Populate lookup tables (idempotent)
          npx prisma db execute --stdin << 'EOSQL'
          INSERT INTO "LookupPurpose" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('MEETING', 'Meeting', true, 1, NOW()),
          ('INTERVIEW', 'Interview', true, 2, NOW()),
          ('DELIVERY', 'Delivery', true, 3, NOW()),
          ('MAINTENANCE', 'Maintenance', true, 4, NOW()),
          ('OTHER', 'Other', true, 5, NOW())
          ON CONFLICT (code) DO NOTHING;

          INSERT INTO "LookupDeliveryType" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('DOCUMENT', 'Document', true, 1, NOW()),
          ('FOOD', 'Food', true, 2, NOW()),
          ('GIFT', 'Gift', true, 3, NOW())
          ON CONFLICT (code) DO NOTHING;

          INSERT INTO "LookupCourier" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('DHL', 'DHL', true, 1, NOW()),
          ('FEDEX', 'FedEx', true, 2, NOW()),
          ('ARAMEX', 'Aramex', true, 3, NOW()),
          ('QATAR_POST', 'Qatar Post', true, 4, NOW()),
          ('UPS', 'UPS', true, 5, NOW()),
          ('TNT', 'TNT Express', true, 6, NOW())
          ON CONFLICT (code) DO NOTHING;

          INSERT INTO "LookupLocation" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('BARWA_TOWERS', 'Barwa Towers', true, 1, NOW()),
          ('MARINA_50', 'Marina 50', true, 2, NOW()),
          ('ELEMENT_MARIOTT', 'Element Mariott', true, 3, NOW())
          ON CONFLICT (code) DO NOTHING;
          EOSQL

          npm run prisma:seed || true
          npm run build

          pm2 delete arafatvisitor-api 2>/dev/null || true
          pm2 start dist/src/main.js --name arafatvisitor-api
          pm2 save
          pm2 startup

          echo "INITIAL_SETUP_COMPLETE"
          ENDSSH

      - name: Deploy Update
        if: github.event.inputs.init != 'true'
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} << 'ENDSSH'
          set -e
          cd /var/www/arafatvisitor/backend

          # Update config from secrets
          sed -i '/^SMTP_/d' .env 2>/dev/null || true
          sed -i '/^WHATSAPP_/d' .env 2>/dev/null || true
          cat >> .env << EOF
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASS=${{ secrets.SMTP_PASS }}
          SMTP_FROM=${{ secrets.SMTP_FROM }}
          WHATSAPP_ENDPOINT=${{ secrets.WHATSAPP_ENDPOINT }}
          WHATSAPP_CLIENT_ID=${{ secrets.WHATSAPP_CLIENT_ID }}
          WHATSAPP_CLIENT=${{ secrets.WHATSAPP_CLIENT }}
          WHATSAPP_API_KEY=${{ secrets.WHATSAPP_API_KEY }}
          EOF

          export $(grep -v '^#' .env | xargs) 2>/dev/null || true

          npm install --include=dev
          npx prisma generate
          npx prisma db push --accept-data-loss

          # ONE-TIME CLEANUP: Remove all test/demo data, keep only admin user
          # TODO: Remove this block after first successful deploy
          npx prisma db execute --stdin << 'EOCLEAN'
          DELETE FROM "QrToken";
          DELETE FROM "Visit";
          DELETE FROM "Delivery";
          DELETE FROM "RefreshToken";
          UPDATE "User" SET "hostId" = NULL WHERE email != 'admin@arafatvisitor.cloud';
          DELETE FROM "User" WHERE email != 'admin@arafatvisitor.cloud';
          DELETE FROM "Host";
          ALTER SEQUENCE "Visit_id_seq" RESTART WITH 1;
          ALTER SEQUENCE "Delivery_id_seq" RESTART WITH 1;
          ALTER SEQUENCE "Host_id_seq" RESTART WITH 1;
          ALTER SEQUENCE "QrToken_id_seq" RESTART WITH 1;
          EOCLEAN

          # Populate lookup tables (idempotent)
          npx prisma db execute --stdin << 'EOSQL'
          INSERT INTO "LookupPurpose" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('MEETING', 'Meeting', true, 1, NOW()),
          ('INTERVIEW', 'Interview', true, 2, NOW()),
          ('DELIVERY', 'Delivery', true, 3, NOW()),
          ('MAINTENANCE', 'Maintenance', true, 4, NOW()),
          ('OTHER', 'Other', true, 5, NOW())
          ON CONFLICT (code) DO NOTHING;

          INSERT INTO "LookupDeliveryType" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('DOCUMENT', 'Document', true, 1, NOW()),
          ('FOOD', 'Food', true, 2, NOW()),
          ('GIFT', 'Gift', true, 3, NOW())
          ON CONFLICT (code) DO NOTHING;

          INSERT INTO "LookupCourier" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('DHL', 'DHL', true, 1, NOW()),
          ('FEDEX', 'FedEx', true, 2, NOW()),
          ('ARAMEX', 'Aramex', true, 3, NOW()),
          ('QATAR_POST', 'Qatar Post', true, 4, NOW()),
          ('UPS', 'UPS', true, 5, NOW()),
          ('TNT', 'TNT Express', true, 6, NOW())
          ON CONFLICT (code) DO NOTHING;

          INSERT INTO "LookupLocation" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('BARWA_TOWERS', 'Barwa Towers', true, 1, NOW()),
          ('MARINA_50', 'Marina 50', true, 2, NOW()),
          ('ELEMENT_MARIOTT', 'Element Mariott', true, 3, NOW())
          ON CONFLICT (code) DO NOTHING;
          EOSQL

          npm run build

          pm2 delete arafatvisitor-api 2>/dev/null || true
          pm2 start dist/src/main.js --name arafatvisitor-api --update-env
          pm2 save

          # Update Nginx config to proxy backend API paths
          cat > /etc/nginx/sites-available/arafatvisitor << 'EONGINX'
          server {
              listen 80;
              server_name ${{ secrets.VPS_DOMAIN }};
              return 301 https://$host$request_uri;
          }

          server {
              listen 443 ssl;
              server_name ${{ secrets.VPS_DOMAIN }};

              ssl_certificate /etc/letsencrypt/live/${{ secrets.VPS_DOMAIN }}/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/${{ secrets.VPS_DOMAIN }}/privkey.pem;

              # Backend API and app routes
              location /admin {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }

              location /api/ {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /hosts {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /visits {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /deliveries {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /lookups {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /health {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              # Kiosk frontend (SPA)
              location / {
                  root /var/www/arafatvisitor/frontend;
                  try_files $uri $uri/ /index.html;
              }
          }
          EONGINX
          ln -sf /etc/nginx/sites-available/arafatvisitor /etc/nginx/sites-enabled/arafatvisitor
          rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
          nginx -t && systemctl reload nginx

          # Wait for app to start, then check status and capture logs
          sleep 5
          echo "=== PM2 STATUS ==="
          pm2 status
          echo "=== PM2 LOGS (last 100 lines) ==="
          pm2 logs arafatvisitor-api --nostream --lines 100 || true
          echo "=== HEALTH CHECK ==="
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:3000/health || echo "Health check failed"
          curl -s http://localhost:3000/health || echo "No response body"

          echo "DEPLOY_COMPLETE"
          ENDSSH

      - name: Stop SSH control master
        if: always()
        continue-on-error: true
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} -O exit ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} 2>/dev/null || true
