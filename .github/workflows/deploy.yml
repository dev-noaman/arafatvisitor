name: Deploy to VPS

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  VPS_PATH: /var/www/arafatvisitor
  DB_NAME: arafatvisitor
  DB_USER: arafatvisitor
  SSH_OPTS: '-o StrictHostKeyChecking=no -o ControlMaster=auto -o ControlPath=/tmp/ssh-%r@%h:%p -o ControlPersist=60s'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build frontend
        run: |
          npm ci
          npm run build
        env:
          VITE_API_BASE: https://${{ secrets.VPS_DOMAIN }}
          VITE_SHOW_DEBUG_LOGIN: "false"

      - name: Build admin
        run: |
          cd admin
          npm ci
          npm run build

      - name: Install sshpass and rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: Start SSH control master
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} -N -f ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }}

      - name: Prepare VPS directories
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} "mkdir -p ${{ env.VPS_PATH }}/frontend ${{ env.VPS_PATH }}/backend"

      - name: Upload frontend
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' rsync -avz --delete -e "sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }}" dist/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }}:${{ env.VPS_PATH }}/frontend/

      - name: Upload backend
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' rsync -avz --delete --exclude 'node_modules' --exclude '.env' --exclude 'dist' -e "sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }}" backend/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }}:${{ env.VPS_PATH }}/backend/

      - name: Deploy
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} << 'ENDSSH'
          set -e
          cd /var/www/arafatvisitor/backend

          # Update config from secrets
          sed -i '/^SMTP_/d' .env 2>/dev/null || true
          sed -i '/^WHATSAPP_/d' .env 2>/dev/null || true
          cat >> .env << EOF
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASS=${{ secrets.SMTP_PASS }}
          SMTP_FROM=${{ secrets.SMTP_FROM }}
          WHATSAPP_ENDPOINT=${{ secrets.WHATSAPP_ENDPOINT }}
          WHATSAPP_CLIENT_ID=${{ secrets.WHATSAPP_CLIENT_ID }}
          WHATSAPP_CLIENT=${{ secrets.WHATSAPP_CLIENT }}
          WHATSAPP_API_KEY=${{ secrets.WHATSAPP_API_KEY }}
          EOF

          export $(grep -v '^#' .env | xargs) 2>/dev/null || true

          npm install --include=dev
          npx prisma generate
          npx prisma db push --accept-data-loss

          # Populate lookup tables (idempotent)
          npx prisma db execute --stdin << 'EOSQL'
          INSERT INTO "LookupPurpose" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('MEETING', 'Meeting', true, 1, NOW()),
          ('INTERVIEW', 'Interview', true, 2, NOW()),
          ('DELIVERY', 'Delivery', true, 3, NOW()),
          ('MAINTENANCE', 'Maintenance', true, 4, NOW()),
          ('OTHER', 'Other', true, 5, NOW())
          ON CONFLICT (code) DO NOTHING;

          INSERT INTO "LookupDeliveryType" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('DOCUMENT', 'Document', true, 1, NOW()),
          ('FOOD', 'Food', true, 2, NOW()),
          ('GIFT', 'Gift', true, 3, NOW())
          ON CONFLICT (code) DO NOTHING;

          ALTER TABLE "LookupCourier" ADD COLUMN IF NOT EXISTS "category" TEXT NOT NULL DEFAULT 'PARCEL';

          INSERT INTO "LookupCourier" (code, label, category, active, "sortOrder", "updatedAt") VALUES
          ('DHL', 'DHL', 'PARCEL', true, 1, NOW()),
          ('FEDEX', 'FedEx', 'PARCEL', true, 2, NOW()),
          ('ARAMEX', 'Aramex', 'PARCEL', true, 3, NOW()),
          ('QATAR_POST', 'Qatar Post', 'PARCEL', true, 4, NOW()),
          ('UPS', 'UPS', 'PARCEL', true, 5, NOW()),
          ('TNT', 'TNT Express', 'PARCEL', true, 6, NOW()),
          ('SNOONU', 'Snoonu', 'FOOD', true, 7, NOW()),
          ('KEETA', 'Keeta', 'FOOD', true, 8, NOW()),
          ('TALABAT', 'Talabat', 'FOOD', true, 9, NOW()),
          ('RAFEEQ', 'Rafeeq', 'FOOD', true, 10, NOW()),
          ('DELIVEROO', 'Deliveroo', 'FOOD', true, 11, NOW()),
          ('NINJA', 'Ninja', 'FOOD', true, 12, NOW())
          ON CONFLICT (code) DO NOTHING;

          INSERT INTO "LookupLocation" (code, label, active, "sortOrder", "updatedAt") VALUES
          ('BARWA_TOWERS', 'Barwa Towers', true, 1, NOW()),
          ('MARINA_50', 'Marina 50', true, 2, NOW()),
          ('ELEMENT_MARIOTT', 'Element Mariott', true, 3, NOW())
          ON CONFLICT (code) DO NOTHING;

          -- Fix existing host phone numbers (one-time cleanup, idempotent)
          -- Step 1: Dual numbers "xxx/xxx" → take left part before "/"
          UPDATE "Host" SET phone = TRIM(SPLIT_PART(phone, '/', 1))
          WHERE phone LIKE '%/%';

          -- Step 2: Strip +, spaces, dashes, parens
          UPDATE "Host" SET phone = REGEXP_REPLACE(REGEXP_REPLACE(phone, '^\\+', ''), '[\\s\\-()]', '', 'g')
          WHERE phone IS NOT NULL AND phone != '';

          -- Step 3: 6 digits → prefix 974
          UPDATE "Host" SET phone = '974' || phone
          WHERE phone ~ '^\d{6}$';

          -- Step 4: 11 digits → prefix 2
          UPDATE "Host" SET phone = '2' || phone
          WHERE phone ~ '^\d{11}$';
          EOSQL

          npm run build

          pm2 delete arafatvisitor-api 2>/dev/null || true
          pm2 start dist/src/main.js --name arafatvisitor-api --update-env
          pm2 save

          # Update Nginx config to proxy backend API paths
          cat > /etc/nginx/sites-available/arafatvisitor << 'EONGINX'
          server {
              listen 80;
              server_name ${{ secrets.VPS_DOMAIN }};
              return 301 https://$host$request_uri;
          }

          server {
              listen 443 ssl;
              server_name ${{ secrets.VPS_DOMAIN }};

              ssl_certificate /etc/letsencrypt/live/${{ secrets.VPS_DOMAIN }}/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/${{ secrets.VPS_DOMAIN }}/privkey.pem;

              # Backend API and app routes
              location /admin {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }

              location /api/ {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /hosts {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /visits {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /deliveries {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /lookups {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /health {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              location /socket.io {
                  proxy_pass http://localhost:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }

              # Kiosk frontend (SPA)
              location / {
                  root /var/www/arafatvisitor/frontend;
                  try_files $uri $uri/ /index.html;
              }
          }
          EONGINX
          ln -sf /etc/nginx/sites-available/arafatvisitor /etc/nginx/sites-enabled/arafatvisitor
          rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true
          nginx -t && systemctl reload nginx

          # Wait for app to start, then check status and capture logs
          sleep 5
          echo "=== PM2 STATUS ==="
          pm2 status
          echo "=== PM2 LOGS (last 100 lines) ==="
          pm2 logs arafatvisitor-api --nostream --lines 100 || true
          echo "=== HEALTH CHECK ==="
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost:3000/health || echo "Health check failed"
          curl -s http://localhost:3000/health || echo "No response body"

          echo "DEPLOY_COMPLETE"
          ENDSSH

      - name: Stop SSH control master
        if: always()
        continue-on-error: true
        run: |
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh ${{ env.SSH_OPTS }} -O exit ${{ secrets.VPS_USER }}@${{ secrets.VPS_IP }} 2>/dev/null || true
